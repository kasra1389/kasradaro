<!DOCTYPE html>
<html lang="fa" dir="rtl"> <head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>چت‌بات کسری دارو</title> <link rel="icon" type="image/x-icon" href="k.png"> <link href="https://cdn.fontcdn.ir/FontShabnam/FDShabnam.css" rel="stylesheet">
    <link href="https://cdn.fontcdn.ir/FontLalezar/Lalezar.css" rel="stylesheet">
    <link href="https://cdn.fontcdn.ir/FontVazirmatn/Vazirmatn.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Raleway:wght@400;600&family=Roboto+Mono:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* حق تکثیر: کسری شیرعلیزاده - شروع بخش استایل‌های CSS */
        /* این بخش شامل تعریف متغیرهای CSS برای تم‌ها و فونت‌های مختلف،
           و همچنین استایل‌های عمومی و اختصاصی برای عناصر مختلف صفحه است.
           هدف اصلی، ایجاد یک ظاهر زیبا، خوانا، و واکنش‌گرا برای چت‌بات است.
        */

        /* تعریف متغیرهای ریشه (root variables) برای فونت‌ها - حق تکثیر: کسری شیرعلیزاده */
        :root {
            /* تعریف فونت‌های پایه برنامه */
            --font-shabnam: 'Shabnam', sans-serif; /* فونت اصلی فارسی: شبنم */
            --font-vazirmatn: 'Vazirmatn', sans-serif; /* فونت فارسی دیگر: وزیرمتن */
            --font-lalezar: 'Lalezar', cursive; /* فونت فارسی تزئینی: لاله‌زار */
            --font-raleway: 'Raleway', sans-serif; /* فونت انگلیسی عمومی: Raleway */
            --font-playfair: 'Playfair Display', serif; /* فونت سریف برای عناوین: Playfair Display */
            --font-monospace: 'Roboto Mono', monospace; /* فونت مونواسپیس برای تم هکری: Roboto Mono */
            --font-lora: 'Lora', serif; /* فونت سریف برای تم مدرن کلاسیک: Lora */

            /* ==================== تعریف متغیرهای تم‌ها ==================== */
            /* حق تکثیر: کسری شیرعلیزاده */

            /* تم نئونی (پیش‌فرض) */
            --neon-bg-primary: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%); /* پس‌زمینه اصلی گرادیانی */
            --neon-text-primary: #e0e0e0; /* رنگ متن اصلی (خاکستری روشن) */
            --neon-text-secondary: #b0b0b0; /* رنگ متن ثانویه (خاکستری تیره‌تر) */
            --neon-accent: #00d4ff; /* رنگ تاکید اصلی (آبی روشن نئونی) */
            --neon-accent-dark: #5a00cc; /* رنگ تاکید تیره‌تر (بنفش نئونی) */
            --neon-sidebar-bg: rgba(20, 20, 40, 0.95); /* پس‌زمینه سایدبار با شفافیت */
            --neon-sidebar-border: rgba(255, 255, 255, 0.2); /* رنگ حاشیه سایدبار */
            --neon-item-bg: rgba(255, 255, 255, 0.05); /* پس‌زمینه آیتم‌های داخل سایدبار و ... */
            --neon-item-hover-bg: rgba(255, 255, 255, 0.15); /* پس‌زمینه آیتم‌ها در حالت هاور */
            --neon-button-glow: rgba(0, 212, 255, 0.6); /* درخشش دکمه‌ها */
            --neon-shadow: rgba(0, 0, 0, 0.8); /* سایه عناصر */
            --neon-input-box-bg: rgba(15, 15, 30, 0.9); /* پس‌زمینه کادر کلی ورودی پیام */
            --neon-input-field-bg: rgba(255, 255, 255, 0.08); /* پس‌زمینه خود فیلد متنی ورودی */
            --neon-input-box-border: rgba(255, 255, 255, 0.3); /* حاشیه کادر ورودی */
            --neon-message-user-bg: linear-gradient(45deg, var(--neon-accent-dark), var(--neon-accent)); /* پس‌زمینه پیام کاربر */
            --neon-message-bot-bg: rgba(255, 255, 255, 0.1); /* پس‌زمینه پیام ربات */
            --neon-font-family: var(--font-shabnam); /* فونت پیش‌فرض برای این تم */

            /* تم طلایی - حق تکثیر: کسری شیرعلیزاده */
            --gold-bg-primary: linear-gradient(135deg, #1c1500 0%, #3a2a00 100%);
            --gold-text-primary: #f0e6b0;
            --gold-text-secondary: #d0b050;
            --gold-accent: #d4a017;
            --gold-accent-dark: #b8860b;
            --gold-sidebar-bg: rgba(40, 30, 0, 0.95);
            --gold-sidebar-border: rgba(212, 160, 23, 0.3);
            --gold-item-bg: rgba(212, 160, 23, 0.05);
            --gold-item-hover-bg: rgba(212, 160, 23, 0.15);
            --gold-button-glow: rgba(212, 160, 23, 0.6);
            --gold-shadow: rgba(0, 0, 0, 0.7);
            --gold-input-box-bg: rgba(30, 22, 0, 0.9);
            --gold-input-field-bg: rgba(212, 160, 23, 0.08);
            --gold-input-box-border: rgba(212, 160, 23, 0.3);
            --gold-message-user-bg: linear-gradient(45deg, var(--gold-accent-dark), var(--gold-accent));
            --gold-message-bot-bg: rgba(212, 160, 23, 0.1);
            --gold-font-family: var(--font-shabnam);

            /* تم نقره‌ای - حق تکثیر: کسری شیرعلیزاده */
            --silver-bg-primary: linear-gradient(135deg, #2a2a2a 0%, #4a4a4a 100%);
            --silver-text-primary: #e0e0e0;
            --silver-text-secondary: #a0a0a0;
            --silver-accent: #c0c0c0;
            --silver-accent-dark: #808080;
            --silver-sidebar-bg: rgba(40, 40, 40, 0.95);
            --silver-sidebar-border: rgba(200, 200, 200, 0.3);
            --silver-item-bg: rgba(200, 200, 200, 0.05);
            --silver-item-hover-bg: rgba(200, 200, 200, 0.15);
            --silver-button-glow: rgba(200, 200, 200, 0.6);
            --silver-shadow: rgba(0, 0, 0, 0.7);
            --silver-input-box-bg: rgba(35,35,35, 0.9);
            --silver-input-field-bg: rgba(200,200,200,0.08);
            --silver-input-box-border: rgba(200, 200, 200, 0.3);
            --silver-message-user-bg: linear-gradient(45deg, var(--silver-accent-dark), var(--silver-accent));
            --silver-message-bot-bg: rgba(200, 200, 200, 0.1);
            --silver-font-family: var(--font-shabnam);

            /* تم رزگلد - حق تکثیر: کسری شیرعلیزاده */
            --rosegold-bg-primary: linear-gradient(135deg, #2a1a1a 0%, #4a2a2a 100%);
            --rosegold-text-primary: #f0d0d0;
            --rosegold-text-secondary: #ffaaaa;
            --rosegold-accent: #ff9999;
            --rosegold-accent-dark: #ff6666;
            --rosegold-sidebar-bg: rgba(40, 20, 20, 0.95);
            --rosegold-sidebar-border: rgba(255, 200, 200, 0.3);
            --rosegold-item-bg: rgba(255, 200, 200, 0.05);
            --rosegold-item-hover-bg: rgba(255, 200, 200, 0.15);
            --rosegold-button-glow: rgba(255, 200, 200, 0.6);
            --rosegold-shadow: rgba(0, 0, 0, 0.7);
            --rosegold-input-box-bg: rgba(35,25,25,0.9);
            --rosegold-input-field-bg: rgba(255,200,200,0.08);
            --rosegold-input-box-border: rgba(255, 200, 200, 0.3);
            --rosegold-message-user-bg: linear-gradient(45deg, var(--rosegold-accent-dark), var(--rosegold-accent));
            --rosegold-message-bot-bg: rgba(255, 200, 200, 0.1);
            --rosegold-font-family: var(--font-shabnam);

            /* تم هکری - حق تکثیر: کسری شیرعلیزاده */
            --hacker-bg-primary: #000000;
            --hacker-text-primary: #00ff00; 
            --hacker-text-secondary: #008000; 
            --hacker-accent: #00ff00;
            --hacker-accent-dark: #008000;
            --hacker-sidebar-bg: rgba(0, 10, 0, 0.9);
            --hacker-sidebar-border: rgba(0, 255, 0, 0.3);
            --hacker-item-bg: rgba(0, 255, 0, 0.05);
            --hacker-item-hover-bg: rgba(0, 255, 0, 0.1);
            --hacker-button-glow: rgba(0, 255, 0, 0.5);
            --hacker-shadow: rgba(0, 50, 0, 0.8);
            --hacker-input-box-bg: rgba(0,10,0,0.9);
            --hacker-input-field-bg: rgba(0,255,0,0.08);
            --hacker-input-box-border: rgba(0, 255, 0, 0.3);
            --hacker-message-user-bg: #003300; 
            --hacker-message-bot-bg: rgba(0, 255, 0, 0.1);
            --hacker-font-family: var(--font-monospace); 

            /* تم فضایی - حق تکثیر: کسری شیرعلیزاده */
            --space-bg-primary: linear-gradient(180deg, #000010 0%, #100020 70%, #300040 100%);
            --space-text-primary: #e0e8ff; 
            --space-text-secondary: #a0b0f0; 
            --space-accent: #aa00ff; 
            --space-accent-dark: #6600cc; 
            --space-sidebar-bg: rgba(5, 0, 15, 0.95);
            --space-sidebar-border: rgba(170, 0, 255, 0.3);
            --space-item-bg: rgba(170, 0, 255, 0.05);
            --space-item-hover-bg: rgba(170, 0, 255, 0.15);
            --space-button-glow: rgba(170, 0, 255, 0.6);
            --space-shadow: rgba(20, 0, 40, 0.8);
            --space-input-box-bg: rgba(5,0,10,0.9);
            --space-input-field-bg: rgba(170,0,255,0.08);
            --space-input-box-border: rgba(170, 0, 255, 0.3);
            --space-message-user-bg: linear-gradient(45deg, var(--space-accent-dark), var(--space-accent));
            --space-message-bot-bg: rgba(170, 0, 255, 0.1);
            --space-font-family: var(--font-raleway);

            /* تم مدرن کلاسیک - حق تکثیر: کسری شیرعلیزاده */
            --modern-classic-bg-primary: #f4f6f8; 
            --modern-classic-text-primary: #333333; 
            --modern-classic-text-secondary: #777777; 
            --modern-classic-accent: #007bff; 
            --modern-classic-accent-dark: #0056b3; 
            --modern-classic-sidebar-bg: #ffffff; 
            --modern-classic-sidebar-border: #dddddd; 
            --modern-classic-item-bg: #f8f9fa; 
            --modern-classic-item-hover-bg: #e9ecef; 
            --modern-classic-button-glow: rgba(0, 123, 255, 0.25);
            --modern-classic-shadow: rgba(0, 0, 0, 0.1);
            --modern-classic-input-box-bg: #ffffff;
            --modern-classic-input-field-bg: #f8f9fa;
            --modern-classic-input-box-border: #ced4da;
            --modern-classic-message-user-bg: var(--modern-classic-accent);
            --modern-classic-message-bot-bg: #e9ecef;
            --modern-classic-font-family: var(--font-lora); 
        }

        /* استایل‌های عمومی بدنه - حق تکثیر: کسری شیرعلیزاده */
        body {
            font-family: var(--current-font-family, var(--font-shabnam)); 
            overflow: hidden; 
            position: relative;
            min-height: 100vh;
            background: var(--bg-primary); 
            color: var(--text-primary); 
            transition: background 0.5s ease, color 0.5s ease; 
        }

        /* استایل عناوین - حق تکثیر: کسری شیرعلیزاده */
        h1, h2, h3, h4 {
            font-family: var(--current-font-family-heading, var(--font-playfair)); 
        }
        /* استثنا برای تم هکری: همه چیز با فونت مونواسپیس */
        .hacker-theme h1, .hacker-theme h2, .hacker-theme h3, .hacker-theme h4, .hacker-theme body {
            font-family: var(--font-monospace) !important;
        }
        /* استثنا برای تم مدرن کلاسیک: عناوین سریف، بدنه سنس-سریف */
         .modern-classic-theme h1, .modern-classic-theme h2, .modern-classic-theme h3, .modern-classic-theme h4 {
            font-family: var(--font-playfair) !important; 
        }
         .modern-classic-theme body {
            font-family: var(--font-raleway) !important; 
        }

        /* اعمال متغیرهای تم‌ها به کلاس‌های مربوطه - حق تکثیر: کسری شیرعلیزاده */
        .neon-theme {
            --bg-primary: var(--neon-bg-primary); --text-primary: var(--neon-text-primary); --text-secondary: var(--neon-text-secondary);
            --accent-color: var(--neon-accent); --accent-color-dark: var(--neon-accent-dark); --sidebar-bg-color: var(--neon-sidebar-bg);
            --sidebar-border-color: var(--neon-sidebar-border); --item-bg-color: var(--neon-item-bg); --item-hover-bg-color: var(--neon-item-hover-bg);
            --button-glow-color: var(--neon-button-glow); --shadow-color: var(--neon-shadow); --input-box-bg-color: var(--neon-input-box-bg);
            --input-field-bg-color: var(--neon-input-field-bg);
            --input-box-border-color: var(--neon-input-box-border); --message-user-bg-color: var(--neon-message-user-bg);
            --message-bot-bg-color: var(--neon-message-bot-bg); --current-font-family: var(--neon-font-family); --current-font-family-heading: var(--font-playfair);
        }
        .gold-theme {
            --bg-primary: var(--gold-bg-primary); --text-primary: var(--gold-text-primary); --text-secondary: var(--gold-text-secondary);
            --accent-color: var(--gold-accent); --accent-color-dark: var(--gold-accent-dark); --sidebar-bg-color: var(--gold-sidebar-bg);
            --sidebar-border-color: var(--gold-sidebar-border); --item-bg-color: var(--gold-item-bg); --item-hover-bg-color: var(--gold-item-hover-bg);
            --button-glow-color: var(--gold-button-glow); --shadow-color: var(--gold-shadow); --input-box-bg-color: var(--gold-input-box-bg);
            --input-field-bg-color: var(--gold-input-field-bg);
            --input-box-border-color: var(--gold-input-box-border); --message-user-bg-color: var(--gold-message-user-bg);
            --message-bot-bg-color: var(--gold-message-bot-bg); --current-font-family: var(--gold-font-family); --current-font-family-heading: var(--font-playfair);
        }
        .silver-theme {
            --bg-primary: var(--silver-bg-primary); --text-primary: var(--silver-text-primary); --text-secondary: var(--silver-text-secondary);
            --accent-color: var(--silver-accent); --accent-color-dark: var(--silver-accent-dark); --sidebar-bg-color: var(--silver-sidebar-bg);
            --sidebar-border-color: var(--silver-sidebar-border); --item-bg-color: var(--silver-item-bg); --item-hover-bg-color: var(--silver-item-hover-bg);
            --button-glow-color: var(--silver-button-glow); --shadow-color: var(--silver-shadow); --input-box-bg-color: var(--silver-input-box-bg);
            --input-field-bg-color: var(--silver-input-field-bg);
            --input-box-border-color: var(--silver-input-box-border); --message-user-bg-color: var(--silver-message-user-bg);
            --message-bot-bg-color: var(--silver-message-bot-bg); --current-font-family: var(--silver-font-family); --current-font-family-heading: var(--font-playfair);
        }
        .rosegold-theme {
            --bg-primary: var(--rosegold-bg-primary); --text-primary: var(--rosegold-text-primary); --text-secondary: var(--rosegold-text-secondary);
            --accent-color: var(--rosegold-accent); --accent-color-dark: var(--rosegold-accent-dark); --sidebar-bg-color: var(--rosegold-sidebar-bg);
            --sidebar-border-color: var(--rosegold-sidebar-border); --item-bg-color: var(--rosegold-item-bg); --item-hover-bg-color: var(--rosegold-item-hover-bg);
            --button-glow-color: var(--rosegold-button-glow); --shadow-color: var(--rosegold-shadow); --input-box-bg-color: var(--rosegold-input-box-bg);
            --input-field-bg-color: var(--rosegold-input-field-bg);
            --input-box-border-color: var(--rosegold-input-box-border); --message-user-bg-color: var(--rosegold-message-user-bg);
            --message-bot-bg-color: var(--rosegold-message-bot-bg); --current-font-family: var(--rosegold-font-family); --current-font-family-heading: var(--font-playfair);
        }
        .hacker-theme {
            --bg-primary: var(--hacker-bg-primary); --text-primary: var(--hacker-text-primary); --text-secondary: var(--hacker-text-secondary);
            --accent-color: var(--hacker-accent); --accent-color-dark: var(--hacker-accent-dark); --sidebar-bg-color: var(--hacker-sidebar-bg);
            --sidebar-border-color: var(--hacker-sidebar-border); --item-bg-color: var(--hacker-item-bg); --item-hover-bg-color: var(--hacker-item-hover-bg);
            --button-glow-color: var(--hacker-button-glow); --shadow-color: var(--hacker-shadow); --input-box-bg-color: var(--hacker-input-box-bg);
            --input-field-bg-color: var(--hacker-input-field-bg);
            --input-box-border-color: var(--hacker-input-box-border); --message-user-bg-color: var(--hacker-message-user-bg);
            --message-bot-bg-color: var(--hacker-message-bot-bg); --current-font-family: var(--hacker-font-family); --current-font-family-heading: var(--hacker-font-family);
        }
        .space-theme {
            --bg-primary: var(--space-bg-primary); --text-primary: var(--space-text-primary); --text-secondary: var(--space-text-secondary);
            --accent-color: var(--space-accent); --accent-color-dark: var(--space-accent-dark); --sidebar-bg-color: var(--space-sidebar-bg);
            --sidebar-border-color: var(--space-sidebar-border); --item-bg-color: var(--space-item-bg); --item-hover-bg-color: var(--space-item-hover-bg);
            --button-glow-color: var(--space-button-glow); --shadow-color: var(--space-shadow); --input-box-bg-color: var(--space-input-box-bg);
            --input-field-bg-color: var(--space-input-field-bg);
            --input-box-border-color: var(--space-input-box-border); --message-user-bg-color: var(--space-message-user-bg);
            --message-bot-bg-color: var(--space-message-bot-bg); --current-font-family: var(--space-font-family); --current-font-family-heading: var(--font-playfair);
        }
        .modern-classic-theme {
            --bg-primary: var(--modern-classic-bg-primary); --text-primary: var(--modern-classic-text-primary); --text-secondary: var(--modern-classic-text-secondary);
            --accent-color: var(--modern-classic-accent); --accent-color-dark: var(--modern-classic-accent-dark); --sidebar-bg-color: var(--modern-classic-sidebar-bg);
            --sidebar-border-color: var(--modern-classic-sidebar-border); --item-bg-color: var(--modern-classic-item-bg); --item-hover-bg-color: var(--modern-classic-item-hover-bg);
            --button-glow-color: var(--modern-classic-button-glow); --shadow-color: var(--modern-classic-shadow); --input-box-bg-color: var(--modern-classic-input-box-bg);
            --input-field-bg-color: var(--modern-classic-input-field-bg);
            --input-box-border-color: var(--modern-classic-input-box-border); --message-user-bg-color: var(--modern-classic-message-user-bg);
            --message-bot-bg-color: var(--modern-classic-message-bot-bg); --current-font-family: var(--modern-classic-font-family); --current-font-family-heading: var(--font-playfair);
        }

        /* استایل کانواس ذرات - حق تکثیر: کسری شیرعلیزاده */
        canvas#particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        /* کانتینر اصلی برنامه - حق تکثیر: کسری شیرعلیزاده */
        .container { display: flex; height: 100vh; width: 100%; position: relative; z-index: 1; }

        /* استایل سایدبار - حق تکثیر: کسری شیرعلیزاده */
        .sidebar {
            width: 20rem; /* عرض سایدبار */
            background: var(--sidebar-bg-color); /* پس‌زمینه سایدبار بر اساس تم */
            padding: 1.5rem 1rem; /* پدینگ داخلی */
            display: flex; /* فعال کردن فلکس‌باکس */
            flex-direction: column; /* چیدمان عمودی آیتم‌ها */
            gap: 0.75rem; /* فاصله بین آیتم‌های سایدبار */
            border-left: 1px solid var(--sidebar-border-color); /* حاشیه سمت چپ (برای زبان فارسی) */
            box-shadow: 1px 0 15px var(--shadow-color); /* سایه سایدبار */
            transition: transform 0.3s ease-in-out !important; /* انیمیشن باز و بسته شدن */
            backdrop-filter: blur(10px); /* افکت بلور برای پس‌زمینه */
            overflow-y: auto; /* اسکرول در صورت نیاز */
            z-index: 100; /* بالاتر از سایر عناصر */
        }
        [dir="ltr"] .sidebar { border-left: none; border-right: 1px solid var(--sidebar-border-color); } /* حاشیه سمت راست برای زبان انگلیسی */

        /* لوگو در سایدبار - حق تکثیر: کسری شیرعلیزاده */
        .logo { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .logo-img { width: 3rem; height: 3rem; border-radius: 50%; box-shadow: 0 0 15px var(--accent-color); }
        .logo h2 { color: var(--accent-color); font-size: 1.75rem; text-shadow: 0 0 10px var(--accent-color), 0 0 20px var(--accent-color); }

        /* استایل دکمه‌های عمومی و دکمه چت جدید - حق تکثیر: کسری شیرعلیزاده */
        .new-chat, .control-button, .sidebar-button {
            background: linear-gradient(45deg, var(--accent-color-dark), var(--accent-color)); /* پس‌زمینه گرادیانی */
            color: white; /* رنگ متن سفید */
            border: none; /* بدون حاشیه */
            padding: 0.6rem 0.75rem; /* پدینگ داخلی */
            border-radius: 0.5rem; /* گردی گوشه‌ها */
            cursor: pointer; /* تغییر نشانگر موس */
            font-size: 0.95rem; /* اندازه فونت */
            font-weight: 600; /* ضخامت فونت */
            transition: transform 0.2s, box-shadow 0.3s; /* انیمیشن نرم */
            box-shadow: 0 0 10px var(--button-glow-color); /* درخشش دکمه */
            text-align: center; /* ترازبندی متن */
        }
        .new-chat:hover, .control-button:hover, .sidebar-button:hover { transform: scale(1.03); box-shadow: 0 0 20px var(--button-glow-color); } /* افکت هاور */

        /* تاریخچه چت‌ها در سایدبار - حق تکثیر: کسری شیرعلیزاده */
        .chat-history { flex-grow: 1; overflow-y: auto; margin-top: 0.5rem; }
        .chat-item {
            margin-bottom: 0.75rem; padding: 0.6rem; border-radius: 0.5rem;
            transition: background 0.3s, transform 0.2s; cursor: pointer;
            background: var(--item-bg-color); display: flex;
            justify-content: space-between; align-items: center;
        }
        .chat-item:hover { background: var(--item-hover-bg-color); transform: translateX(-3px); }
        [dir="ltr"] .chat-item:hover { transform: translateX(3px); }
        .chat-item h4 { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item p { color: var(--text-primary); font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .chat-item .chat-actions { display: flex; gap: 0.2rem; }
        .chat-item .chat-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.75rem; padding: 0.15rem; }
        .chat-item .chat-actions button:hover { color: var(--accent-color); }

        /* بخش‌های آکاردئونی در سایدبار - حق تکثیر: کسری شیرعلیزاده */
        .sidebar-section { margin-top: 0.75rem; border-radius: 0.5rem; background: var(--item-bg-color); }
        .sidebar-section .section-title { 
            color: var(--text-secondary); font-size: 0.95rem; font-weight: 600;
            padding: 0.6rem 0.75rem; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid transparent; 
        }
        .sidebar-section .section-title:hover { background: var(--item-hover-bg-color); border-radius: 0.5rem 0.5rem 0 0; }
        .sidebar-section .section-content { 
            background: var(--item-hover-bg-color); padding: 0.75rem; 
            border-radius: 0 0 0.5rem 0.5rem;
            text-align: var(--text-align-direction, right); 
        }
        [dir="ltr"] .sidebar-section .section-content { --text-align-direction: left; }
        .sidebar-section .section-content p { font-size: 0.85rem; margin-bottom: 0.3rem; color: var(--text-primary); }
        .sidebar-section .section-content a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        .sidebar-section .section-content a:hover { text-decoration: underline; }
        .sidebar-section .section-content button { margin-top: 0.5rem; font-size: 0.9rem; padding: 0.5rem 1rem; }
        .sidebar-section .section-title .arrow { transition: transform 0.3s ease; } /* انیمیشن فلش آکاردئون */
        .sidebar-section .section-title[aria-expanded="true"] .arrow { transform: rotate(180deg); }
        .social-links a { margin: 0 0.3rem; display: inline-block; } /* استایل لینک‌های اجتماعی */
        .social-links svg { width: 1.2rem; height: 1.2rem; fill: var(--accent-color); transition: fill 0.2s; }
        .social-links a:hover svg { fill: var(--accent-color-dark); }


        /* بخش اصلی چت (سمت راست یا چپ) - حق تکثیر: کسری شیرعلیزاده */
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem; overflow-y: hidden; }
        /* هدر بخش چت - حق تکثیر: کسری شیرعلیزاده */
        .chat-header { text-align: center; padding: 0.5rem 0; margin-bottom: 1rem; position: relative; }
        .datetime { margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); }
        .chat-header h3 { font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--accent-color); text-shadow: 0 0 10px var(--accent-color); }
        .chat-header p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .chat-header .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .chat-header .controls button { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
        
        /* مودال جستجو - حق تکثیر: کسری شیرعلیزاده */
        .search-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: flex-start; 
            z-index: 1500; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            padding-top: 10vh; 
        }
        .search-modal-overlay.active { opacity: 1; visibility: visible; }
        .search-modal-content {
            background: var(--sidebar-bg-color); color: var(--text-primary); padding: 1.5rem;
            border-radius: 0.8rem; width: 90%; max-width: 500px; 
            box-shadow: 0 10px 30px var(--shadow-color); position: relative;
            border: 1px solid var(--sidebar-border-color);
        }
        .search-modal-content h3 { color: var(--accent-color); margin-bottom: 1rem; text-align: center; font-size: 1.2rem;}
        .search-modal-input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .search-modal-input-group input { 
            flex-grow: 1; padding: 0.6rem; border-radius: 0.4rem;
            border: 1px solid var(--sidebar-border-color);
            background: var(--item-bg-color); color: var(--text-primary); font-size: 0.9rem;
        }
        .search-modal-input-group button { padding: 0.6rem 1rem; font-size: 0.9rem;}
        #searchResultsContainer { max-height: 50vh; overflow-y: auto; }
        .search-result-item-modal {
            padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.4rem;
            background: var(--item-hover-bg-color); cursor: pointer;
        }
        .search-result-item-modal:hover { background: var(--accent-color); color: white; }
        .search-result-item-modal strong { display: block; margin-bottom: 0.2rem; font-size: 0.8rem; color: var(--text-secondary); }
        .search-modal-content .search-result-item-modal:hover strong { color: rgba(255,255,255,0.8); }
        .search-result-item-modal p { font-size: 0.9rem; }
        .search-modal-close-btn {
            position: absolute; top: 0.5rem; right: 0.5rem; 
            background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;
        }
        [dir="ltr"] .search-modal-close-btn { right: auto; left: 0.5rem; }

        /* نمایش پیام‌ها - حق تکثیر: کسری شیرعلیزاده */
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; }
        .message-container { display: flex; flex-direction: column; margin-bottom: 0.5rem; } /* کانتینر هر پیام با متادیتا */
        .message-container.user { align-items: flex-end; } /* پیام کاربر سمت راست/چپ */
        .message-container.bot { align-items: flex-start; } /* پیام ربات سمت مقابل */

        .message-bubble { /* حباب اصلی پیام */
            max-width: 75%; 
            padding: 0.6rem 1rem; 
            border-radius: 1rem;
            backdrop-filter: blur(5px); 
            border: 1px solid var(--input-box-border-color); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
            word-wrap: break-word; 
            position: relative;
        }
        .message-bubble.user { background: var(--message-user-bg-color); color: white; border-bottom-right-radius: 0.25rem; } 
        .message-bubble.bot { background: var(--message-bot-bg-color); color: var(--text-primary); border-bottom-left-radius: 0.25rem; } 
        [dir="ltr"] .message-bubble.user { border-bottom-left-radius: 0.25rem; border-bottom-right-radius: 1rem; }
        [dir="ltr"] .message-bubble.bot { border-bottom-right-radius: 0.25rem; border-bottom-left-radius: 1rem; }

        .message-text { display: block; } /* متن پیام */
        
        /* نوار زیر پیام برای زمان و دکمه‌ها - حق تکثیر: کسری شیرعلیزاده */
        .message-meta-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem; 
            margin-top: 0.4rem; 
            padding: 0 0.5rem; 
            width: fit-content; /* عرض متناسب با محتوا */
            max-width: 100%; /* جلوگیری از سرریز شدن */
        }
        .message-container.user .message-meta-actions { margin-right: auto; /* برای زبان فارسی */ }
        .message-container.bot .message-meta-actions { margin-left: auto; /* برای زبان فارسی */ }
        [dir="ltr"] .message-container.user .message-meta-actions { margin-left: auto; margin-right: 0; }
        [dir="ltr"] .message-container.bot .message-meta-actions { margin-right: auto; margin-left: 0; }


        /* زمان ارسال پیام - حق تکثیر: کسری شیرعلیزاده */
        .message-timestamp-meta {
            font-size: 0.65rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        /* دکمه‌های عملیات روی پیام - حق تکثیر: کسری شیرعلیزاده */
        .message-actions-meta {
            display: flex;
            gap: 0.5rem; 
        }
        .message-actions-meta button { background: none; color: var(--text-secondary); border:none; cursor:pointer; padding: 0.1rem; display:flex; align-items:center; }
        .message-actions-meta button:hover { color: var(--accent-color); }
        .message-actions-meta button svg { width: 0.9rem; height: 0.9rem; margin-right: 0.1rem; } 
        [dir="rtl"] .message-actions-meta button svg { margin-left: 0.1rem; margin-right: 0; }
        .message-actions-meta .like-count, .message-actions-meta .dislike-count { font-size: 0.6rem; margin-left: 0.1rem; }
        .message-actions-meta .liked, .message-actions-meta .disliked { color: var(--accent-color) !important; }


        /* کادر ورودی پیام - حق تکثیر: کسری شیرعلیزاده */
        .chat-input-box {
            background: var(--input-box-bg-color); padding: 0.75rem 1rem; 
            border-radius: 12px 12px 0 0; 
            box-shadow: 0 -5px 20px var(--shadow-color), inset 0 0 10px var(--item-hover-bg-color);
            backdrop-filter: blur(10px); border-top: 1px solid var(--input-box-border-color);
            margin: 0 -1rem -1rem -1rem; 
        }
        .chat-input-inner { 
            display: flex; align-items: center; gap: 0.5rem; 
            background: var(--input-field-bg-color); 
            padding: 0.5rem 0.75rem; border-radius: 8px; 
            border: 1px solid var(--input-box-border-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-inner:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color-dark);
        }
        .chat-input-inner input, .message-edit-input {
            flex-grow: 1; padding: 0.5rem; background: transparent; border: none; 
            color: var(--text-primary); font-size: 1rem; outline: none;
        }
        .message-edit-input { width:100%; border: 1px solid var(--accent-color) !important; border-radius: 0.3rem; margin-bottom: 0.3rem;}
        .chat-input-inner input::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .clear-input-btn {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            padding: 0.25rem; margin-right: 0.25rem; 
            opacity: 0.6; transition: opacity 0.2s;
        }
        [dir="ltr"] .clear-input-btn { margin-left: 0.25rem; margin-right: 0; }
        .clear-input-btn:hover { opacity: 1; }
        .clear-input-btn svg { width: 1rem; height: 1rem; }

        .chat-buttons { display: flex; gap: 0.3rem; }
        .chat-buttons button, .edit-actions button {
            background: var(--accent-color); color: white; border: none;
            border-radius: 6px; cursor: pointer; font-size: 1.2rem; 
            width: 2.25rem; height: 2.25rem; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, transform 0.2s;
        }
        .edit-actions button { width: auto; height: auto; padding: 0.3rem 0.5rem; font-size: 0.8rem;}
        .chat-buttons button:hover, .edit-actions button:hover { background: var(--accent-color-dark); transform: scale(1.05); }
        .chat-buttons .send-btn { background: var(--accent-color-dark); }
        .chat-buttons .send-btn:hover { background: var(--accent-color); }
        
        /* پیشنهادهای پاسخ - حق تکثیر: کسری شیرعلیزاده */
        #replySuggestionsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem 0;
            justify-content: center;
        }
        .suggestion-chip {
            background-color: var(--item-bg-color);
            color: var(--text-primary);
            padding: 0.4rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--sidebar-border-color);
            transition: background-color 0.2s, color 0.2s;
        }
        .suggestion-chip:hover {
            background-color: var(--accent-color);
            color: white;
        }
        #suggestionSpinner {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.5rem;
        }
        /* دکمه اسکرول به پایین - حق تکثیر: کسری شیرعلیزاده */
        #scrollToBottomBtn {
            position: absolute;
            bottom: 7rem; 
            right: 1.5rem; 
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 50;
        }
        [dir="ltr"] #scrollToBottomBtn { right: auto; left: 1.5rem; }
        #scrollToBottomBtn.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        #scrollToBottomBtn:hover { background-color: var(--accent-color-dark); }


        /* پنل تنظیمات - حق تکثیر: کسری شیرعلیزاده */
        .settings-panel {
            position: fixed; top: 4rem; right: 1rem; background: var(--sidebar-bg-color);
            padding: 1.5rem; border-radius: 0.8rem; box-shadow: 0 5px 20px var(--shadow-color);
            backdrop-filter: blur(10px); border: 1px solid var(--sidebar-border-color);
            display: none; animation: fadeInSettings 0.3s ease-out; z-index: 1001;
            max-width: 280px; width: 90%; max-height: calc(100vh - 5rem); overflow-y: auto;
        }
        [dir="ltr"] .settings-panel { right: auto; left: 1rem; }
        @keyframes fadeInSettings { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .settings-panel h4 { font-size: 1.2rem; margin-bottom: 1rem; text-align: center; color: var(--accent-color); }
        .setting-item { margin-bottom: 1rem; }
        .setting-item label { display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        .setting-item select, .setting-item input[type="range"], .setting-item .toggle-switch {
            width: 100%; padding: 0.5rem; border-radius: 0.4rem; border: 1px solid var(--sidebar-border-color);
            background: var(--item-bg-color); color: var(--text-primary); font-size: 0.9rem;
        }
        .setting-item select:focus, .setting-item input[type="range"]:focus { outline: 1px solid var(--accent-color); }
        .toggle-switch { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.8rem; cursor:pointer; background: var(--item-hover-bg-color); }
        .toggle-switch span { color: var(--text-primary); }
        .toggle-switch .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .toggle-switch .switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .toggle-switch .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-switch input:checked + .slider { background-color: var(--accent-color); }
        .toggle-switch input:checked + .slider:before { transform: translateX(14px); }
        .settings-panel .sidebar-button { margin-top: 0.5rem; width: 100%;} 


        /* دکمه همبرگری برای موبایل - حق تکثیر: کسری شیرعلیزاده */
        .hamburger {
            display: none; position: fixed; top: 1rem; right: 1rem; background: var(--accent-color);
            color: white; border: none; border-radius: 0.3rem; padding: 0.5rem 0.7rem;
            font-size: 1.5rem; z-index: 1002; cursor: pointer;
        }
        [dir="ltr"] .hamburger { right: auto; left: 1rem; }

        /* مودال راهنما - حق تکثیر: کسری شیرعلیزاده */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--sidebar-bg-color); color: var(--text-primary); padding: 2rem;
            border-radius: 0.8rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 10px 30px var(--shadow-color); position: relative;
            border: 1px solid var(--sidebar-border-color);
        }
        .modal-content h3 { color: var(--accent-color); margin-bottom: 1rem; text-align: center; }
        .modal-content p, .modal-content li { margin-bottom: 0.5rem; font-size: 0.9rem; line-height: 1.6; }
        .modal-content ul { list-style: disc; padding-right: 1.5rem; } 
        [dir="ltr"] .modal-content ul { padding-left: 1.5rem; padding-right: 0; }
        .modal-close-btn {
            position: absolute; top: 0.8rem; right: 0.8rem; 
            background: none; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer;
        }
        [dir="ltr"] .modal-close-btn { right: auto; left: 0.8rem; }
        .modal-close-btn:hover { color: var(--accent-color); }


        /* استایل‌های واکنش‌گرا - حق تکثیر: کسری شیرعلیزاده */
        @media (max-width: 768px) { /* تبلت و موبایل‌های بزرگ */
            .sidebar {
                position: fixed; top: 0; right: -100%; height: 100%;
                width: 80%; max-width: 300px; z-index: 1000;
            }
            [dir="ltr"] .sidebar { right: auto; left: -100%; }
            .sidebar.active { transform: translateX(-100%); }
            [dir="ltr"] .sidebar.active { transform: translateX(100%); }
            .hamburger { display: block; }
            .chat-main { padding: 0.5rem; }
            .chat-header h3 { font-size: 1.5rem; }
            .chat-header p { font-size: 0.9rem; }
            .chat-header .controls { gap: 0.3rem; }
            .chat-header .controls button { padding: 0.4rem 0.6rem; font-size: 0.7rem; }
            .message-bubble { max-width: 85%; } 
            .chat-input-box { margin: 0 -0.5rem -0.5rem -0.5rem; padding: 0.75rem; }
            .chat-input-inner { padding: 0.4rem; }
            .chat-input-inner input { padding: 0.6rem; font-size: 0.9rem;}
            .chat-buttons button { width: 2.2rem; height: 2.2rem; font-size: 1rem; }
            .settings-panel { width: calc(100% - 2rem); max-width: 280px; top: 3.5rem; }
            .message-actions-meta button svg { width: 0.8rem; height: 0.8rem;} 
        }
        @media (max-width: 480px) { /* موبایل‌های کوچک */
            .sidebar { width: 90%; max-width: none; }
            .logo h2 { font-size: 1.5rem; }
            .new-chat { font-size: 0.9rem; padding: 0.6rem; }
            .chat-item h4 { font-size: 0.8rem; } .chat-item p { font-size: 0.75rem; }
            .chat-header h3 { font-size: 1.3rem; } .chat-messages { gap: 0.5rem; }
            .message-bubble { padding: 0.6rem 0.8rem; border-radius: 0.6rem; } 
            .chat-input-box { border-radius: 0.8rem 0.8rem 0 0; }
            .message-meta-actions { gap: 0.5rem; flex-wrap: wrap; justify-content: center;} 
            .message-actions-meta { gap: 0.3rem; }
            .message-actions-meta button svg { width: 0.7rem; height: 0.7rem;}
            #scrollToBottomBtn { bottom: 6.5rem; right: 1rem; width:2.2rem; height:2.2rem; font-size:1rem;}
            [dir="ltr"] #scrollToBottomBtn { left: 1rem; }
        }

        /* استایل اسکرول‌بار - حق تکثیر: کسری شیرعلیزاده */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color-dark); }
        .hidden { display: none !important; } /* کلاس کمکی برای مخفی کردن عناصر */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; } /* برای دسترسی‌پذیری */
    </style>
</head>
<body class="neon-theme"> <canvas id="particles"></canvas> <div class="container mx-auto"> <button class="hamburger" id="hamburgerBtn" aria-label="Toggle sidebar">☰</button> <div class="sidebar" id="sidebar" role="navigation"> <div class="logo"> <img src="k.png" alt="کسری دارو" class="logo-img"> <h2 data-translate-key="kasriDaru">کسری دارو</h2> </div>

            <button class="new-chat sidebar-button" id="newChatBtn" data-translate-key="newChat">💬 چت جدید</button> <div class="chat-history" id="chatHistory" aria-live="polite"> </div>
            
            <div class="sidebar-section">
                <p class="section-title" id="toggleSearchSectionBtn" data-translate-key="searchInChats" tabindex="0" role="button" aria-expanded="false">🔍 جستجو در چت‌ها <span class="arrow">▼</span></p>
                <div class="section-content hidden" id="searchSectionContent">
                     <p class="text-xs mb-2" data-translate-key="openSearchModalHint">برای جستجوی پیشرفته، روی دکمه زیر کلیک کنید.</p>
                    <button id="openSearchModalSidebarBtn" class="control-button w-full text-sm" data-translate-key="openAdvancedSearch">باز کردن جستجوی پیشرفته</button>
                </div>
            </div>

            <div class="sidebar-section">
                <p class="section-title" id="toggleMoreInfoBtn" data-translate-key="moreInformation" tabindex="0" role="button" aria-expanded="false">ℹ️ اطلاعات بیشتر <span class="arrow">▼</span></p>
                <div class="section-content hidden" id="moreInfoContent">
                    <div class="mb-2"> <p class="font-semibold text-[color:var(--accent-color)]" data-translate-key="myProfile">👤 پروفایل من</p>
                        <p><span data-translate-key="name">نام</span>: <span data-translate-key="kasriUser">کاربر کسری</span></p>
                        <p><span data-translate-key="email">ایمیل</span>: user@kasridaru.com</p>
                    </div>
                    <hr class="border-[color:var(--sidebar-border-color)] my-2"> <div class="mb-2"> <p class="font-semibold text-[color:var(--accent-color)]" data-translate-key="contactUs">📞 تماس با ما</p>
                        <p>کسری شیرعلیزاده</p>
                        <p><a href="tel:09145325706">0914-532-5706</a></p>
                        <p><a href="mailto:kasri@example.com">kasri@example.com</a></p>
                    </div>
                    <hr class="border-[color:var(--sidebar-border-color)] my-2"> <div> <p class="font-semibold text-[color:var(--accent-color)]" data-translate-key="aboutCreator">✨ درباره سازنده</p>
                        <p data-translate-key="creatorName">نام سازنده: کسری شیرعلیزاده</p>
                        <p data-translate-key="creatorBio">یک توسعه‌دهنده علاقه‌مند به ساخت ابزارهای مفید و خلاقانه!</p>
                        <p><a href="https://github.com/kasra-shir" target="_blank" rel="noopener noreferrer">GitHub</a></p>
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <p class="section-title" id="toggleUsefulLinksBtn" data-translate-key="usefulLinks" tabindex="0" role="button" aria-expanded="false">🔗 پیوندهای مفید <span class="arrow">▼</span></p>
                <div class="section-content hidden" id="usefulLinksContent">
                    <div class="social-links text-center">
                        <a href="https://google.com" target="_blank" rel="noopener noreferrer" title="Google">
                            <svg viewBox="0 0 24 24"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z" /></svg>
                        </a>
                        <a href="https://linkedin.com/in/kasra-shir/" target="_blank" rel="noopener noreferrer" title="LinkedIn">
                            <svg viewBox="0 0 24 24"><path d="M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3H19M18.5,18.5V13.2A3.26,3.26 0 0,0 15.24,9.94C14.39,9.94 13.4,10.43 12.9,11.24V10.13H10.13V18.5H12.9V13.57C12.9,12.8 13.54,12.17 14.31,12.17A1.4,1.4 0 0,1 15.71,13.57V18.5H18.5M6.88,8.56A1.68,1.68 0 0,0 8.56,6.88C8.56,5.95 7.81,5.19 6.88,5.19A1.69,1.69 0 0,0 5.19,6.88C5.19,7.81 5.95,8.56 6.88,8.56M8.27,18.5V10.13H5.5V18.5H8.27Z" /></svg>
                        </a>
                        <a href="https://youtube.com" target="_blank" rel="noopener noreferrer" title="YouTube"> <svg viewBox="0 0 24 24"><path d="M10,15L15.19,12L10,9V15M21.56,7.17C21.69,7.64 21.78,8.27 21.84,9.08C21.91,9.87 21.94,10.56 21.94,11.16L22,12C22,14.19 21.84,15.8 21.56,16.83C21.31,17.73 20.73,18.31 19.83,18.56C19.36,18.69 18.73,18.78 17.92,18.84C17.13,18.91 16.44,18.94 15.84,18.94L15,19C12.81,19 11.2,18.84 10.17,18.56C9.27,18.31 8.69,17.73 8.44,16.83C8.31,16.36 8.22,15.73 8.16,14.92C8.09,14.13 8.06,13.44 8.06,12.84L8,12C8,9.81 8.16,8.2 8.44,7.17C8.69,6.27 9.27,5.69 10.17,5.44C10.64,5.31 11.27,5.22 12.08,5.16C12.87,5.09 13.56,5.06 14.16,5.06L15,5C17.19,5 18.8,5.16 19.83,5.44C20.73,5.69 21.31,6.27 21.56,7.17Z" /></svg>
                        </a>
                    </div>
                </div>
            </div>
             <div class="sidebar-section">
                <p class="section-title" id="toggleSystemInfoBtn" data-translate-key="systemInformation" tabindex="0" role="button" aria-expanded="false">💻 اطلاعات سیستم <span class="arrow">▼</span></p>
                <div class="section-content hidden" id="systemInfoContent">
                    <p><strong data-translate-key="browser">مرورگر:</strong> <span id="browserInfo"></span></p>
                    <p><strong data-translate-key="os">سیستم‌عامل:</strong> <span id="osInfo"></span></p>
                    <p><strong data-translate-key="languagePreferences">زبان‌های مرورگر:</strong> <span id="langPrefsInfo"></span></p>
                </div>
            </div>

            <div class="sidebar-section">
                <p class="section-title" id="toggleAdSectionBtn" data-translate-key="advertisements" tabindex="0" role="button" aria-expanded="false">تبلیغات <span class="arrow">▼</span></p>
                <div class="section-content hidden" id="adSectionContent">
                    <p data-translate-key="newProducts">محصولات جدید کسری دارو!</p>
                    <button id="visitSiteAdBtn" class="control-button" data-translate-key="learnMore">بیشتر بدانید</button>
                </div>
            </div>
        </div>

        <main class="chat-main" role="main"> <div class="chat-header"> <div class="datetime" id="dateTime"></div> <h3 data-translate-key="chatBotWelcome">سلام، من چت‌بات کسری دارو هستم.</h3> <p data-translate-key="howCanIHelp">چطور می‌تونم بهت کمک کنم؟</p> <div class="controls"> <button class="control-button" id="settingsBtn" data-translate-key="settings" aria-haspopup="true" aria-expanded="false">⚙️ تنظیمات</button>
                    <button class="control-button" id="summarizeChatBtn" data-translate-key="summarizeChat">✨ خلاصه کردن</button>
                    <button class="control-button" id="clearCurrentChatBtn" data-translate-key="clearCurrentChat">🗑️ پاک کردن این چت</button>
                    <button class="control-button md:hidden" id="hideSidebarBtn" data-translate-key="sidebarToggle">⬅️ سایدبار</button>
                    </div>
            </div>

            <div class="chat-messages" id="chatMessages" aria-live="polite"> </div>
            
            <div id="replySuggestionsContainer">
                </div>
            <div id="suggestionSpinner" class="hidden" data-translate-key="thinkingOfReplies">✨ در حال فکر کردن به پاسخ‌ها...</div> <button id="scrollToBottomBtn" class="hidden" title="Scroll to bottom" aria-label="Scroll to bottom">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.638l3.96-4.03a.75.75 0 111.08 1.04l-5.25 5.5a.75.75 0 01-1.08 0l-5.25-5.5a.75.75 0 111.08-1.04l3.96 4.03V3.75A.75.75 0 0110 3z" clip-rule="evenodd" />
                </svg>
            </button>


            <div class="chat-input-box"> <div class="chat-input-inner"> <input type="text" id="userInput" data-translate-key-placeholder="typeMessagePlaceholder" placeholder="پیام خود را بنویسید..." aria-label="Type your message">
                    <button id="clearInputBtn" class="clear-input-btn hidden" title="Clear input" aria-label="Clear input"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="chat-buttons"> <button id="sendBtn" title="Send message" aria-label="Send message">➤</button> </div>
                </div>
            </div>
        </main>

        <div class="settings-panel" id="settingsPanel" role="dialog" aria-modal="true" aria-labelledby="settingsPanelTitle">
             <button class="modal-close-btn" id="closeSettingsPanelBtn" aria-label="Close settings panel">×</button>
            <h4 id="settingsPanelTitle" data-translate-key="settingsTitle">تنظیمات</h4>
            <div class="setting-item">
                <label for="themeSelect" data-translate-key="theme">تم:</label>
                <select id="themeSelect" aria-label="Select theme">
                    <option value="neon" data-translate-key="neon">نئونی</option>
                    <option value="gold" data-translate-key="gold">طلایی</option>
                    <option value="silver" data-translate-key="silver">نقره‌ای</option>
                    <option value="rosegold" data-translate-key="rosegold">رزگلد</option>
                    <option value="hacker" data-translate-key="hacker">هکری</option>
                    <option value="space" data-translate-key="space">فضایی</option>
                    <option value="modern-classic" data-translate-key="modernClassic">مدرن کلاسیک</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="fontSelect" data-translate-key="font">فونت:</label>
                <select id="fontSelect" aria-label="Select font">
                    <option value="Shabnam" data-translate-key="shabnam">شبنم</option>
                    <option value="Vazirmatn" data-translate-key="vazirmatn">وزیرمتن</option>
                    <option value="Lalezar" data-translate-key="lalezar">لاله‌زار</option>
                    <option value="Raleway" data-translate-key="ralewayEn">Raleway (Eng)</option>
                    <option value="Playfair Display" data-translate-key="playfairEn">Playfair Display (Eng)</option>
                    <option value="Roboto Mono" data-translate-key="monospaceEn">Monospace (Eng)</option>
                    <option value="Lora" data-translate-key="loraEn">Lora (Eng)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="languageSelect" data-translate-key="language">زبان:</label>
                <select id="languageSelect" aria-label="Select language">
                    <option value="fa">فارسی (Persian)</option>
                    <option value="en">English</option>
                    <option value="az">Azərbaycanca (Azerbaijani)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="fontSizeSlider" data-translate-key="fontSize">اندازه فونت:</label>
                <input type="range" min="12" max="24" value="16" id="fontSizeSlider" aria-label="Adjust font size">
            </div>
            <div class="setting-item">
                 <label for="particleToggle" class="toggle-switch" data-translate-key="toggleParticles">
                    <span>انیمیشن ذرات</span>
                    <span class="switch">
                        <input type="checkbox" id="particleToggle" checked aria-labelledby="particleToggleLabel">
                        <span class="slider"></span>
                    </span>
                </label>
            </div>
            <button id="resetSettingsBtn" class="sidebar-button control-button" data-translate-key="resetSettings">بازنشانی تنظیمات</button>
            <button id="helpGuideBtn" class="sidebar-button control-button" data-translate-key="helpGuide">راهنما</button>
        </div>
    </div>

    <div class="modal-overlay" id="helpModalOverlay">
        <div class="modal-content" role="document" aria-labelledby="helpModalTitle">
            <button class="modal-close-btn" id="closeHelpModalBtn" aria-label="Close help guide">×</button>
            <h3 id="helpModalTitle" data-translate-key="helpGuideTitle">راهنمای چت‌بات کسری دارو</h3>
            <div id="helpModalContent">
                </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="searchModalOverlay">
        <div class="search-modal-content" role="document" aria-labelledby="searchModalTitle">
            <button class="search-modal-close-btn" id="closeSearchModalBtn" aria-label="Close search modal">×</button>
            <h3 id="searchModalTitle" data-translate-key="searchInAllChats">جستجو در تمام چت‌ها</h3>
            <div class="search-modal-input-group">
                <input type="text" id="modalSearchInput" data-translate-key-placeholder="typeKeywordPlaceholder" placeholder="کلمه کلیدی را وارد کنید...">
                <button id="modalSearchExecuteBtn" class="control-button" data-translate-key="search">جستجو</button>
            </div>
            <div id="searchResultsContainer">
                </div>
        </div>
    </div>


    <audio id="sendSound" src="https://www.soundjay.com/buttons/beep-01a.mp3" preload="auto"></audio> <audio id="receiveSound" src="https://www.soundjay.com/buttons/beep-02.mp3" preload="auto"></audio> <script>
        // اسکریپت اصلی برنامه - حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        // 📌 [1] انتخاب عناصر DOM (Document Object Model)
        // این بخش متغیرهایی را تعریف می‌کند که به عناصر مختلف HTML در صفحه اشاره دارند.
        // این کار باعث می‌شود تا بتوانیم با استفاده از جاوااسکریپت، این عناصر را دستکاری کرده و با آن‌ها تعامل داشته باشیم.
        // حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        const chatMessagesEl = document.getElementById('chatMessages'); 
        const userInputEl = document.getElementById('userInput'); 
        const clearInputBtn = document.getElementById('clearInputBtn'); 
        const chatHistoryEl = document.getElementById('chatHistory'); 
        const sidebarEl = document.getElementById('sidebar'); 
        const settingsPanelEl = document.getElementById('settingsPanel'); 
        const closeSettingsPanelBtn = document.getElementById('closeSettingsPanelBtn'); // دکمه بستن پنل تنظیمات
        const fontSizeSliderEl = document.getElementById('fontSizeSlider'); 
        const dateTimeEl = document.getElementById('dateTime'); 
        const sendSoundEl = document.getElementById('sendSound'); 
        const receiveSoundEl = document.getElementById('receiveSound'); 
        const sendBtn = document.getElementById('sendBtn'); 
        const newChatBtn = document.getElementById('newChatBtn'); 
        const settingsBtn = document.getElementById('settingsBtn'); 
        const summarizeChatBtn = document.getElementById('summarizeChatBtn'); 
        const clearCurrentChatBtn = document.getElementById('clearCurrentChatBtn');
        const replySuggestionsContainerEl = document.getElementById('replySuggestionsContainer'); 
        const suggestionSpinnerEl = document.getElementById('suggestionSpinner'); 
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const hideSidebarBtn = document.getElementById('hideSidebarBtn'); 
        const visitSiteAdBtn = document.getElementById('visitSiteAdBtn'); 
        
        const toggleSearchSectionBtn = document.getElementById('toggleSearchSectionBtn'); 
        const openSearchModalSidebarBtn = document.getElementById('openSearchModalSidebarBtn'); // دکمه باز کردن مودال جستجو از سایدبار

        const themeSelectEl = document.getElementById('themeSelect'); 
        const fontSelectEl = document.getElementById('fontSelect'); 
        const languageSelectEl = document.getElementById('languageSelect'); 
        const hamburgerBtn = document.getElementById('hamburgerBtn'); 
        
        const toggleAdSectionBtn = document.getElementById('toggleAdSectionBtn'); 
        const adSectionContentEl = document.getElementById('adSectionContent'); 
        const toggleMoreInfoBtn = document.getElementById('toggleMoreInfoBtn'); 
        const moreInfoContentEl = document.getElementById('moreInfoContent'); 
        const toggleUsefulLinksBtn = document.getElementById('toggleUsefulLinksBtn'); 
        const usefulLinksContentEl = document.getElementById('usefulLinksContent'); 
        const toggleSystemInfoBtn = document.getElementById('toggleSystemInfoBtn'); // دکمه اطلاعات سیستم
        const systemInfoContentEl = document.getElementById('systemInfoContent'); // محتوای اطلاعات سیستم
        const browserInfoEl = document.getElementById('browserInfo'); // نمایش اطلاعات مرورگر
        const osInfoEl = document.getElementById('osInfo'); // نمایش اطلاعات سیستم عامل
        const langPrefsInfoEl = document.getElementById('langPrefsInfo'); // نمایش زبانهای مرجح مرورگر


        const particleToggleEl = document.getElementById('particleToggle'); 
        const resetSettingsBtn = document.getElementById('resetSettingsBtn'); 
        const helpGuideBtn = document.getElementById('helpGuideBtn'); 
        const helpModalOverlayEl = document.getElementById('helpModalOverlay'); 
        const helpModalContentEl = document.getElementById('helpModalContent'); 
        const closeHelpModalBtn = document.getElementById('closeHelpModalBtn'); 
        
        const searchModalOverlayEl = document.getElementById('searchModalOverlay'); 
        const modalSearchInputEl = document.getElementById('modalSearchInput'); 
        const modalSearchExecuteBtn = document.getElementById('modalSearchExecuteBtn'); 
        const searchResultsContainerEl = document.getElementById('searchResultsContainer'); 
        const closeSearchModalBtn = document.getElementById('closeSearchModalBtn'); 

        const bodyEl = document.body; 
        const htmlEl = document.documentElement; 
        
        const particlesArray = []; // آرایه برای نگهداری ذرات انیمیشن پس‌زمینه - حق تکثیر: کسری شیرعلیزاده

        // ====================================================================================================
        // 📌 [2] متغیرهای وضعیت و تنظیمات برنامه
        // این بخش شامل متغیرهایی است که وضعیت فعلی برنامه (مانند چت فعال، تم انتخاب شده، زبان و ...)
        // و همچنین تنظیمات پیش‌فرض و رشته‌های متنی برای زبان‌های مختلف را نگهداری می‌کنند.
        // حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        let chatSessions = []; 
        let currentChatId = null; 
        let currentTheme = localStorage.getItem('kasriChatTheme') || 'neon'; 
        let currentLanguage = localStorage.getItem('kasriChatLanguage') || 'fa'; 
        let currentFont = localStorage.getItem('kasriChatFont') || 'Shabnam'; 
        let currentFontSize = localStorage.getItem('kasriChatFontSize') || '16'; 
        let particlesEnabled = (localStorage.getItem('kasriParticlesEnabled') === 'false' ? false : true); 
        let isSending = false; 
        let isSummarizing = false; 
        let isSuggesting = false; 

        // تنظیمات پیش‌فرض برنامه - حق تکثیر: کسری شیرعلیزاده
        const defaultSettings = {
            theme: 'neon',
            language: 'fa',
            font: 'Shabnam',
            fontSize: '16',
            particlesEnabled: true,
        };

        // رشته‌های متنی برای زبان‌های مختلف (فارسی و انگلیسی و آذربایجانی) - حق تکثیر: کسری شیرعلیزاده
        const uiStrings = {
            fa: { /* ... رشته‌های فارسی ... */ 
                kasriDaru: "کسری دارو", newChat: "💬 چت جدید", advertisements: "تبلیغات", newProducts: "محصولات جدید کسری دارو!", learnMore: "بیشتر بدانید",
                myProfile: "👤 پروفایل من", name: "نام", kasriUser: "کاربر کسری", email: "ایمیل", contactUs: "📞 تماس با ما", aboutCreator: "✨ درباره سازنده", creatorName: "نام سازنده: کسری شیرعلیزاده", creatorBio: "یک توسعه‌دهنده علاقه‌مند به ساخت ابزارهای مفید و خلاقانه!",
                moreInformation: "ℹ️ اطلاعات بیشتر", usefulLinks: "🔗 پیوندهای مفید", google: "گوگل", linkedin: "لینکدین", youtube: "یوتیوب", systemInformation: "💻 اطلاعات سیستم", browser: "مرورگر", os: "سیستم‌عامل", languagePreferences: "زبان‌های مرورگر",
                chatBotWelcome: "سلام، من چت‌بات کسری دارو هستم.", howCanIHelp: "چطور می‌تونم بهت کمک کنم؟",
                settings: "⚙️ تنظیمات", sidebarToggle: "سایدبار", visitSite: "🌐 بازدید از سایت",
                searchHistoryPlaceholder: "کلمه کلیدی...", typeMessagePlaceholder: "پیام خود را بنویسید...",
                settingsTitle: "تنظیمات", theme: "تم:", neon: "نئونی", gold: "طلایی", silver: "نقره‌ای", rosegold: "رزگلد", hacker: "هکری", space: "فضایی", modernClassic: "مدرن کلاسیک",
                font: "فونت:", shabnam: "شبنم", vazirmatn: "وزیرمتن", lalezar: "لاله‌زار", ralewayEn: "Raleway (Eng)", playfairEn: "Playfair Display (Eng)", monospaceEn: "Monospace (Eng)", loraEn: "Lora (Eng)",
                language: "زبان:", fontSize: "اندازه فونت:", toggleParticles: "انیمیشن ذرات", resetSettings: "بازنشانی تنظیمات", helpGuide: "راهنما",
                processing: "در حال پردازش...", serverError: "خطا در ارتباط با سرور!", fetchError: "خطا در ارسال پیام. لطفا اتصال اینترنت خود را بررسی کنید.",
                noResponse: "متاسفم، پاسخی دریافت نشد.", promptBlocked: "درخواست شما به دلیل {REASON} مسدود شد.", harmfulContent: "(محتوای مرتبط با: {CATEGORIES})",
                chatDefaultName: "چت ", confirmDeleteChat: "آیا مطمئن هستید که می‌خواهید این چت را حذف کنید؟", enterNewChatName: "نام جدید چت را وارد کنید:",
                noResultsFound: "نتیجه‌ای یافت نشد!", searchResultsTitle: "{COUNT} نتیجه یافت شد", viewChat: "مشاهده چت",
                messageLiked: "پیام لایک شد", messageDisliked: "پیام دیسلایک شد", initialBotMessage: "سلام! برای شروع گفتگو، پیامت رو بنویس.",
                edit: "ویرایش", delete: "حذف", copy: "کپی", share: "اشتراک", save: "ذخیره", cancel: "لغو", copiedToClipboard: "متن در کلیپ‌بورد کپی شد!",
                shareNotSupported: "اشتراک‌گذاری در این مرورگر پشتیبانی نمی‌شود. متن کپی شد.",
                helpGuideTitle: "راهنمای چت‌بات کسری دارو",
                helpIntro: "به راهنمای چت‌بات کسری دارو خوش آمدید! در اینجا با امکانات مختلف آشنا می‌شوید:",
                helpThemes: "<strong>تغییر تم:</strong> از بخش تنظیمات می‌توانید ظاهر برنامه را با تم‌های متنوع (نئونی، طلایی، هکری، فضایی و...) تغییر دهید.",
                helpLanguage: "<strong>تغییر زبان:</strong> زبان رابط کاربری را به فارسی، انگلیسی یا آذربایجانی تغییر دهید.",
                helpFont: "<strong>تغییر فونت و اندازه:</strong> فونت و اندازه متن‌ها را به دلخواه خود تنظیم کنید.",
                helpParticles: "<strong>انیمیشن ذرات:</strong> افکت ذرات پس‌زمینه را فعال یا غیرفعال کنید.",
                helpNewChat: "<strong>چت جدید:</strong> با کلیک روی دکمه 'چت جدید' یک گفتگوی تازه شروع کنید.",
                helpChatHistory: "<strong>تاریخچه چت:</strong> گفتگوهای قبلی شما در سایدبار ذخیره می‌شوند. می‌توانید نام آن‌ها را ویرایش یا حذف کنید.",
                helpMessageActions: "<strong>عملیات روی پیام:</strong> برای هر پیام گزینه‌هایی مانند ویرایش (برای پیام‌های خودتان)، حذف، کپی، اشتراک‌گذاری، لایک و دیس‌لایک وجود دارد.",
                helpSearch: "<strong>جستجو:</strong> در تاریخچه گفتگوهای خود جستجو کنید.",
                helpReset: "<strong>بازنشانی تنظیمات:</strong> تمام تنظیمات ظاهری را به حالت پیش‌فرض برگردانید.",
                confirmResetSettings: "آیا از بازنشانی تمام تنظیمات به حالت پیش‌فرض مطمئن هستید؟ تاریخچه چت‌ها حذف نخواهد شد.",
                settingsReset: "تنظیمات با موفقیت بازنشانی شد.",
                summarizeChat: "✨ خلاصه کردن",
                summarizingChat: "✨ در حال خلاصه کردن گفتگو...",
                chatSummary: "خلاصه گفتگو:",
                thinkingOfReplies: "✨ در حال فکر کردن به پاسخ‌ها...",
                noSuggestions: "پیشنهادی یافت نشد.",
                helpSummarize: "<strong>✨ خلاصه کردن گفتگو:</strong> با کلیک روی دکمه 'خلاصه کردن' در هدر، خلاصه‌ای از مکالمه فعلی را دریافت کنید.",
                helpSuggestReplies: "<strong>✨ پیشنهاد پاسخ:</strong> پس از هر پیام ربات، پاسخ‌های پیشنهادی کوتاهی نمایش داده می‌شود که می‌توانید از آن‌ها استفاده کنید.",
                helpMessageTimestamp: "<strong>✨ زمان پیام:</strong> زمان ارسال هر پیام در کنار آن نمایش داده می‌شود.",
                helpScrollToBottom: "<strong>✨ اسکرول به پایین:</strong> اگر در پیام‌ها به بالا اسکرول کنید، دکمه‌ای برای بازگشت سریع به آخرین پیام ظاهر می‌شود.",
                helpClearInput: "<strong>✨ پاک کردن ورودی:</strong> دکمه 'x' در کادر ورودی به شما امکان پاک کردن سریع متن را می‌دهد.",
                clearCurrentChat: "🗑️ پاک کردن این چت",
                confirmClearCurrentChat: "آیا از پاک کردن تمام پیام‌های این چت مطمئن هستید؟ این عمل قابل بازگشت نیست.",
                searchInChats: "🔍 جستجو در چت‌ها",
                search: "جستجو",
                typeKeywordPlaceholder: "کلمه کلیدی را وارد کنید...",
                searchInAllChats: "جستجو در تمام چت‌ها",
                openAdvancedSearch: "باز کردن جستجوی پیشرفته",
                helpSystemInfo: "<strong>💻 اطلاعات سیستم:</strong> اطلاعاتی درباره مرورگر و سیستم‌عامل شما نمایش داده می‌شود.",
            },
            en: { /* ... English strings ... */ 
                kasriDaru: "Kasri Daru", newChat: "💬 New Chat", advertisements: "Advertisements", newProducts: "New Kasri Daru products!", learnMore: "Learn More",
                myProfile: "👤 My Profile", name: "Name", kasriUser: "Kasri User", email: "Email", contactUs: "📞 Contact Us", aboutCreator: "✨ About Creator", creatorName: "Creator: Kasra ShirAlizadeh", creatorBio: "A passionate developer building useful and creative tools!",
                moreInformation: "ℹ️ More Information", usefulLinks: "🔗 Useful Links", google: "Google", linkedin: "LinkedIn", youtube: "YouTube", systemInformation: "💻 System Information", browser: "Browser", os: "Operating System", languagePreferences: "Browser Languages",
                chatBotWelcome: "Hello, I am Kasri Daru Chatbot.", howCanIHelp: "How can I help you?",
                settings: "⚙️ Settings", sidebarToggle: "Sidebar", visitSite: "🌐 Visit Site",
                searchHistoryPlaceholder: "Keyword...", typeMessagePlaceholder: "Type your message...",
                settingsTitle: "Settings", theme: "Theme:", neon: "Neon", gold: "Gold", silver: "Silver", rosegold: "Rosegold", hacker: "Hacker", space: "Space", modernClassic: "Modern Classic",
                font: "Font:", shabnam: "Shabnam", vazirmatn: "Vazirmatn", lalezar: "Lalezar", ralewayEn: "Raleway (Eng)", playfairEn: "Playfair Display (Eng)", monospaceEn: "Monospace (Eng)", loraEn: "Lora (Eng)",
                language: "Language:", fontSize: "Font Size:", toggleParticles: "Particle Animation", resetSettings: "Reset Settings", helpGuide: "Help Guide",
                processing: "Processing...", serverError: "Server Error!", fetchError: "Error sending message. Check connection.",
                noResponse: "Sorry, no response was received.", promptBlocked: "Request blocked due to {REASON}.", harmfulContent: "(Content related to: {CATEGORIES})",
                chatDefaultName: "Chat ", confirmDeleteChat: "Are you sure you want to delete this chat?", enterNewChatName: "Enter new chat name:",
                noResultsFound: "No results found!", searchResultsTitle: "{COUNT} results found", viewChat: "View Chat",
                messageLiked: "Message liked", messageDisliked: "Message disliked", initialBotMessage: "Hello! Type your message to start.",
                edit: "Edit", delete: "Delete", copy: "Copy", share: "Share", save: "Save", cancel: "Cancel", copiedToClipboard: "Copied to clipboard!",
                shareNotSupported: "Sharing not supported. Text copied.",
                helpGuideTitle: "Kasri Daru Chatbot Guide",
                helpIntro: "Welcome to the Kasri Daru Chatbot guide! Here’s how to use its features:",
                helpThemes: "<strong>Change Theme:</strong> Customize the app's appearance with various themes (Neon, Gold, Hacker, Space, etc.) from Settings.",
                helpLanguage: "<strong>Change Language:</strong> Switch the UI language between Persian, English, or Azerbaijani.",
                helpFont: "<strong>Change Font & Size:</strong> Adjust the font and text size to your preference.",
                helpParticles: "<strong>Particle Animation:</strong> Enable or disable the background particle effect.",
                helpNewChat: "<strong>New Chat:</strong> Start a fresh conversation by clicking 'New Chat'.",
                helpChatHistory: "<strong>Chat History:</strong> Previous chats are saved in the sidebar. You can edit their names or delete them.",
                helpMessageActions: "<strong>Message Actions:</strong> Each message has options like Edit (for your messages), Delete, Copy, Share, Like, and Dislike.",
                helpSearch: "<strong>Search:</strong> Search through your chat history.",
                helpReset: "<strong>Reset Settings:</strong> Revert all appearance settings to their defaults.",
                confirmResetSettings: "Are you sure you want to reset all settings to default? Chat history will not be deleted.",
                settingsReset: "Settings reset successfully.",
                summarizeChat: "✨ Summarize",
                summarizingChat: "✨ Summarizing chat...",
                chatSummary: "Chat Summary:",
                thinkingOfReplies: "✨ Thinking of replies...",
                noSuggestions: "No suggestions found.",
                helpSummarize: "<strong>✨ Summarize Chat:</strong> Click the 'Summarize' button in the header to get a summary of the current conversation.",
                helpSuggestReplies: "<strong>✨ Suggest Replies:</strong> After each bot message, short reply suggestions will appear for your convenience.",
                helpMessageTimestamp: "<strong>✨ Message Timestamp:</strong> The time each message was sent is displayed next to it.",
                helpScrollToBottom: "<strong>✨ Scroll to Bottom:</strong> If you scroll up in messages, a button will appear to quickly return to the latest message.",
                helpClearInput: "<strong>✨ Clear Input:</strong> An 'x' button in the input field allows you to quickly clear the text.",
                clearCurrentChat: "🗑️ Clear This Chat",
                confirmClearCurrentChat: "Are you sure you want to clear all messages in this chat? This action cannot be undone.",
                searchInChats: "🔍 Search in Chats",
                search: "Search",
                typeKeywordPlaceholder: "Enter keyword...",
                searchInAllChats: "Search in All Chats",
                openAdvancedSearch: "Open Advanced Search",
                helpSystemInfo: "<strong>💻 System Information:</strong> Displays information about your browser and operating system.",
            },
            az: { // Azerbaijani translations - حق تکثیر: کسری شیرعلیزاده
                kasriDaru: "Kəsri Dərman", newChat: "💬 Yeni Söhbət", advertisements: "Reklamlar", newProducts: "Yeni Kəsri Dərman məhsulları!", learnMore: "Daha çox öyrən",
                myProfile: "👤 Profilim", name: "Ad", kasriUser: "Kəsri İstifadəçi", email: "E-poçt", contactUs: "📞 Bizimlə Əlaqə", aboutCreator: "✨ Yaradıcı Haqqında", creatorName: "Yaradıcı: Kəsra Şirəlizadə", creatorBio: "Faydalı və kreativ alətlər yaratmağa həvəsli bir developer!",
                moreInformation: "ℹ️ Ətraflı Məlumat", usefulLinks: "🔗 Faydalı Keçidlər", google: "Google", linkedin: "LinkedIn", youtube: "YouTube", systemInformation: "💻 Sistem Məlumatı", browser: "Brauzer", os: "Əməliyyat Sistemi", languagePreferences: "Brauzer Dilləri",
                chatBotWelcome: "Salam, mən Kəsri Dərman Çatbotuyam.", howCanIHelp: "Sizə necə kömək edə bilərəm?",
                settings: "⚙️ Parametrlər", sidebarToggle: "Yan Panel", visitSite: "🌐 Sayta Keçid",
                searchHistoryPlaceholder: "Açar söz...", typeMessagePlaceholder: "Mesajınızı yazın...",
                settingsTitle: "Parametrlər", theme: "Mövzu:", neon: "Neon", gold: "Qızıl", silver: "Gümüş", rosegold: "Çəhrayı Qızıl", hacker: "Haker", space: "Kosmos", modernClassic: "Müasir Klassik",
                font: "Şrift:", shabnam: "Şəbnəm", vazirmatn: "Vəzirmətn", lalezar: "Laləzar", ralewayEn: "Raleway (Eng)", playfairEn: "Playfair Display (Eng)", monospaceEn: "Monospace (Eng)", loraEn: "Lora (Eng)",
                language: "Dil:", fontSize: "Şrift Ölçüsü:", toggleParticles: "Zərrəcik Animasiyası", resetSettings: "Parametrləri Sıfırla", helpGuide: "Köməkçi",
                processing: "Emal edilir...", serverError: "Serverdə xəta baş verdi!", fetchError: "Mesaj göndərilərkən xəta. İnternet bağlantınızı yoxlayın.",
                noResponse: "Bağışlayın, cavab alınmadı.", promptBlocked: "{REASON} səbəbindən sorğunuz bloklandı.", harmfulContent: "(Məzmunla əlaqəli: {CATEGORIES})",
                chatDefaultName: "Söhbət ", confirmDeleteChat: "Bu söhbəti silmək istədiyinizə əminsiniz?", enterNewChatName: "Yeni söhbət adını daxil edin:",
                noResultsFound: "Nəticə tapılmadı!", searchResultsTitle: "{COUNT} nəticə tapıldı", viewChat: "Söhbətə Bax",
                messageLiked: "Mesaj bəyənildi", messageDisliked: "Mesaj bəyənilmədi", initialBotMessage: "Salam! Danışığa başlamaq üçün mesajınızı yazın.",
                edit: "Redaktə et", delete: "Sil", copy: "Kopyala", share: "Paylaş", save: "Yadda saxla", cancel: "Ləğv et", copiedToClipboard: "Mətn mübadilə buferinə kopyalandı!",
                shareNotSupported: "Paylaşım bu brauzerdə dəstəklənmir. Mətn kopyalandı.",
                helpGuideTitle: "Kəsri Dərman Çatbot Köməkçisi",
                helpIntro: "Kəsri Dərman Çatbot köməkçisinə xoş gəlmisiniz! Xüsusiyyətlərdən necə istifadə edəcəyinizə dair məlumat:",
                helpThemes: "<strong>Mövzunu Dəyiş:</strong> Parametrlərdən tətbiqin görünüşünü müxtəlif mövzularla (Neon, Qızıl, Haker, Kosmos və s.) fərdiləşdirin.",
                helpLanguage: "<strong>Dili Dəyiş:</strong> İstifadəçi interfeysinin dilini Farsca, İngiliscə və ya Azərbaycanca olaraq dəyişin.",
                helpFont: "<strong>Şrifti və Ölçünü Dəyiş:</strong> Şrifti və mətn ölçüsünü istəyinizə uyğun tənzimləyin.",
                helpParticles: "<strong>Zərrəcik Animasiyası:</strong> Arxa fon zərrəcik effektini aktivləşdirin və ya deaktiv edin.",
                helpNewChat: "<strong>Yeni Söhbət:</strong> 'Yeni Söhbət' düyməsinə klikləyərək təzə bir danışıq başladın.",
                helpChatHistory: "<strong>Söhbət Tarixçəsi:</strong> Əvvəlki söhbətləriniz yan paneldə saxlanılır. Adlarını redaktə edə və ya silə bilərsiniz.",
                helpMessageActions: "<strong>Mesaj Əməliyyatları:</strong> Hər mesaj üçün Redaktə et (öz mesajlarınız üçün), Sil, Kopyala, Paylaş, Bəyən və Bəyənmə kimi seçimlər mövcuddur.",
                helpSearch: "<strong>Axtarış:</strong> Söhbət tarixçənizdə axtarış edin.",
                helpReset: "<strong>Parametrləri Sıfırla:</strong> Bütün görünüş parametrlərini standart vəziyyətinə qaytarın.",
                confirmResetSettings: "Bütün parametrləri standart vəziyyətinə qaytarmaq istədiyinizə əminsiniz? Söhbət tarixçələri silinməyəcək.",
                settingsReset: "Parametrlər uğurla sıfırlandı.",
                summarizeChat: "✨ Xülasə et",
                summarizingChat: "✨ Söhbət xülasə edilir...",
                chatSummary: "Söhbət Xülasəsi:",
                thinkingOfReplies: "✨ Cavablar düşünülür...",
                noSuggestions: "Təklif tapılmadı.",
                helpSummarize: "<strong>✨ Söhbəti Xülasə et:</strong> Başlıqdakı 'Xülasə et' düyməsinə klikləyərək mövcud söhbətin xülasəsini əldə edin.",
                helpSuggestReplies: "<strong>✨ Cavab Təklif et:</strong> Hər bot mesajından sonra, rahatlığınız üçün qısa cavab təklifləri görünəcək.",
                helpMessageTimestamp: "<strong>✨ Mesaj Zamanı:</strong> Hər mesajın göndərilmə vaxtı yanında göstərilir.",
                helpScrollToBottom: "<strong>✨ Aşağıya Sürüşdür:</strong> Mesajlarda yuxarı sürüşdürsəniz, ən son mesaja tez qayıtmaq üçün bir düymə görünəcək.",
                helpClearInput: "<strong>✨ Girişi Təmizlə:</strong> Giriş sahəsindəki 'x' düyməsi mətni tez təmizləməyə imkan verir.",
                clearCurrentChat: "🗑️ Bu Söhbəti Təmizlə",
                confirmClearCurrentChat: "Bu söhbətdəki bütün mesajları təmizləmək istədiyinizə əminsiniz? Bu əməliyyat geri qaytarıla bilməz.",
                searchInChats: "🔍 Söhbətlərdə Axtar",
                search: "Axtar",
                typeKeywordPlaceholder: "Açar söz daxil edin...",
                searchInAllChats: "Bütün Söhbətlərdə Axtar",
                openAdvancedSearch: "Ətraflı Axtarışı Aç",
                helpSystemInfo: "<strong>💻 Sistem Məlumatı:</strong> Brauzeriniz və əməliyyat sisteminiz haqqında məlumatları göstərir.",
            }
        };

        // ====================================================================================================
        // 📌 [3] سیستم ذرات پس‌زمینه (Particle System)
        // این بخش مسئول ایجاد و انیمیشن ذراتی است که در پس‌زمینه صفحه حرکت می‌کنند.
        // این افکت بصری به زیبایی و جذابیت برنامه کمک می‌کند.
        // حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        const canvas = document.getElementById('particles'); 
        const ctx = canvas.getContext('2d'); 
        let animationFrameId; 

        function setupCanvas() {
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }

        class Particle { /* ... (Particle class definition - unchanged) ... */ 
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2.5 + 0.5;
                this.speedX = Math.random() * 0.4 - 0.2;
                this.speedY = Math.random() * 0.4 - 0.2;
                this.color = this.getColor();
                if (currentTheme === 'space') { 
                    this.opacity = Math.random() * 0.5 + 0.3; 
                    this.twinkleSpeed = Math.random() * 0.05 + 0.01;
                }
            }
            getColor() {
                const themeColors = { 
                    neon: `hsl(${Math.random() * 60 + 180}, 100%, 70%)`,
                    gold: `hsl(${Math.random() * 20 + 40}, 90%, 60%)`,
                    silver: `hsl(0, 0%, ${Math.random() * 30 + 60}%)`,
                    rosegold: `hsl(${Math.random() * 20 + 340}, 80%, 70%)`,
                    hacker: `rgba(0, 255, 0, ${Math.random() * 0.5 + 0.2})`, 
                    space: `rgba(200, 220, 255, ${this.opacity || (Math.random() * 0.5 + 0.3)})` ,
                    'modern-classic': `rgba(var(--modern-classic-accent-rgb, 0, 123, 255), ${Math.random() * 0.3 + 0.1})` 
                };
                 if (currentTheme === 'modern-classic') { 
                    const rgbString = getComputedStyle(document.documentElement).getPropertyValue('--modern-classic-accent').trim();
                    const rgbMatch = rgbString.match(/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);
                    if (rgbMatch) {
                        return `rgba(${rgbMatch[1]}, ${rgbMatch[2]}, ${rgbMatch[3]}, ${Math.random() * 0.3 + 0.1})`;
                    } else { 
                        return `rgba(0, 123, 255, ${Math.random() * 0.3 + 0.1})`;
                    }
                }
                return themeColors[currentTheme] || themeColors.neon; 
            }
            update() {
                this.x += this.speedX; 
                this.y += this.speedY; 
                if (currentTheme === 'space') {
                    this.opacity += this.twinkleSpeed;
                    if (this.opacity > 1 || this.opacity < 0.1) this.twinkleSpeed *= -1; 
                    this.color = `rgba(200, 220, 255, ${this.opacity})`;
                } else if (this.size > 0.1) { 
                    this.size -= 0.01;
                }
                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = this.color; 
                ctx.beginPath(); 
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                if (currentTheme !== 'space' && currentTheme !== 'modern-classic') { 
                    ctx.shadowBlur = currentTheme === 'hacker' ? 3 : 5; 
                    ctx.shadowColor = this.color; 
                }
                ctx.fill(); 
            }
        }

        function initParticles() { /* ... (initParticles function - unchanged) ... */ 
            if (!particlesEnabled) { 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                if (animationFrameId) cancelAnimationFrame(animationFrameId); 
                return;
            }
            setupCanvas(); 
            particlesArray.length = 0; 
            const numParticles = currentTheme === 'space' ? 150 : (currentTheme === 'hacker' ? 50 : (currentTheme === 'modern-classic' ? 20 : 30));
            for (let i = 0; i < numParticles; i++) {
                particlesArray.push(new Particle()); 
            }
        }

        function animateParticles() { /* ... (animateParticles function - unchanged) ... */ 
            if (!particlesEnabled) return; 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            for (let i = 0; i < particlesArray.length; i++) { 
                particlesArray[i].update(); 
                particlesArray[i].draw(); 
                if (currentTheme !== 'space' && particlesArray[i].size <= 0.1) {
                    particlesArray.splice(i, 1); 
                    i--; 
                    const numParticles = currentTheme === 'hacker' ? 50 : (currentTheme === 'modern-classic' ? 20 : 30);
                    if (particlesArray.length < numParticles) { 
                         particlesArray.push(new Particle());
                    }
                }
            }
            animationFrameId = requestAnimationFrame(animateParticles); 
        }
        
        window.addEventListener('resize', () => { /* ... (resize event listener - unchanged) ... */ 
            if (particlesEnabled) {
                initParticles(); 
            } else {
                setupCanvas(); 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            }
        });

        // ====================================================================================================
        // 📌 [4] توابع مربوط به به‌روزرسانی رابط کاربری (UI Update Functions)
        // این توابع مسئول اعمال تغییرات ظاهری مانند تم، فونت، زبان و اندازه فونت هستند.
        // حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        function applyTheme(theme) { /* ... (applyTheme function - unchanged) ... */ 
            bodyEl.className = `${theme}-theme`; 
            localStorage.setItem('kasriChatTheme', theme); 
            currentTheme = theme; 
            if (animationFrameId) cancelAnimationFrame(animationFrameId); 
            initParticles(); 
            if (particlesEnabled) animateParticles(); 
            if (theme === 'hacker') {
                 applyFont('Roboto Mono', false); 
            } else if (theme === 'modern-classic') {
                 applyFont('Lora', false); 
            }
            else { 
                 applyFont(localStorage.getItem('kasriChatFont') || defaultSettings.font, true); 
            }
        }

        function applyFont(font, savePreference = true) { /* ... (applyFont function - unchanged) ... */ 
            let fontFamilyToApply = ''; 
            let headingFontFamilyToApply = ''; 

            switch(font) {
                case 'Shabnam': 
                    fontFamilyToApply = `var(--font-shabnam)`; 
                    headingFontFamilyToApply = `var(--font-playfair)`; 
                    break;
                case 'Vazirmatn': // اضافه کردن فونت وزیرمتن
                    fontFamilyToApply = `var(--font-vazirmatn)`;
                    headingFontFamilyToApply = `var(--font-playfair)`;
                    break;
                case 'Lalezar': // اضافه کردن فونت لاله‌زار
                    fontFamilyToApply = `var(--font-lalezar)`;
                    headingFontFamilyToApply = `var(--font-lalezar)`; // لاله‌زار برای عناوین هم مناسب است
                    break;
                case 'Raleway': 
                    fontFamilyToApply = `var(--font-raleway)`; 
                    headingFontFamilyToApply = `var(--font-playfair)`; 
                    break;
                case 'Playfair Display': 
                    fontFamilyToApply = `var(--font-playfair)`;  
                    headingFontFamilyToApply = `var(--font-playfair)`;
                    break;
                case 'Roboto Mono': 
                    fontFamilyToApply = `var(--font-monospace)`; 
                    headingFontFamilyToApply = `var(--font-monospace)`;
                    break;
                case 'Lora':
                    fontFamilyToApply = `var(--font-lora)`;
                    headingFontFamilyToApply = `var(--font-playfair)`; 
                    break;
                default: 
                    fontFamilyToApply = `var(--font-shabnam)`;
                    headingFontFamilyToApply = `var(--font-playfair)`;
            }

            if (currentTheme === 'hacker') { 
                fontFamilyToApply = `var(--font-monospace)`;
                headingFontFamilyToApply = `var(--font-monospace)`;
            } else if (currentTheme === 'modern-classic') {
                fontFamilyToApply = `var(--font-raleway)`; 
                headingFontFamilyToApply = `var(--font-lora)`; 
            }

            bodyEl.style.fontFamily = fontFamilyToApply; 
            document.querySelectorAll('h1, h2, h3, h4').forEach(h => h.style.fontFamily = headingFontFamilyToApply); 
            
            if (savePreference) { 
                localStorage.setItem('kasriChatFont', font); 
                currentFont = font; 
            }
        }


        function applyFontSize(size) { /* ... (applyFontSize function - unchanged) ... */ 
            htmlEl.style.fontSize = `${size}px`; 
            localStorage.setItem('kasriChatFontSize', size); 
            currentFontSize = size; 
        }

        function applyLanguage(lang) { /* ... (applyLanguage function - unchanged, ensure az is handled in uiStrings) ... */ 
            currentLanguage = lang; 
            localStorage.setItem('kasriChatLanguage', lang); 
            htmlEl.lang = lang; 
            htmlEl.dir = lang === 'fa' || lang === 'az' ? 'rtl' : 'ltr'; // آذربایجانی هم راست به چپ است
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey; 
                if (uiStrings[lang] && uiStrings[lang][key]) el.textContent = uiStrings[lang][key]; 
                else if (uiStrings['en'][key]) el.textContent = uiStrings['en'][key]; // فال‌بک به انگلیسی اگر ترجمه موجود نبود
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.dataset.translateKeyPlaceholder;
                if (uiStrings[lang] && uiStrings[lang][key]) el.placeholder = uiStrings[lang][key];
                else if (uiStrings['en'][key]) el.placeholder = uiStrings['en'][key];
            });
            renderChatHistory(); 
            if (currentChatId !== null && chatSessions[currentChatId]?.messages.length === 1 && chatSessions[currentChatId].messages[0].sender === 'bot') {
                chatSessions[currentChatId].messages[0].text = uiStrings[currentLanguage].initialBotMessage;
                saveChatSessions();
                renderChatMessages();
            }
            updateHelpModalContent(); 
        }

        function toggleParticles(enabled) { /* ... (toggleParticles function - unchanged) ... */ 
            particlesEnabled = enabled; 
            localStorage.setItem('kasriParticlesEnabled', enabled); 
            if (enabled) { 
                initParticles(); 
                animateParticles(); 
            } else { 
                if (animationFrameId) cancelAnimationFrame(animationFrameId); 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            }
        }

        function parseMarkdown(text) { /* ... (parseMarkdown function - unchanged) ... */ 
            let html = text;
            html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>');
            html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>');
            return html; 
        }


        // ====================================================================================================
        // 📌 [5] توابع اصلی مربوط به چت (Chat Functions)
        // این بخش شامل توابع اصلی برای ارسال و دریافت پیام، مدیریت تاریخچه،
        // عملیات روی پیام‌ها (لایک، حذف، ویرایش و ...) و تعامل با Gemini API است.
        // حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        function addMessageToDOM(text, sender, msgId, likes = 0, dislikes = 0, userLiked = false, userDisliked = false, timestamp = Date.now()) { /* ... (addMessageToDOM - unchanged from previous correct version) ... */ 
            const messageContainer = document.createElement('div'); 
            messageContainer.classList.add('message-container', sender); 
            messageContainer.dataset.id = msgId; 

            const messageBubble = document.createElement('div'); 
            messageBubble.classList.add('message-bubble', sender); 

            const textSpan = document.createElement('span'); 
            textSpan.classList.add('message-text');
            textSpan.innerHTML = parseMarkdown(text.replace(/\n/g, '<br>')); 
            messageBubble.appendChild(textSpan); 
            messageContainer.appendChild(messageBubble); 

            const metaActionsDiv = document.createElement('div');
            metaActionsDiv.className = 'message-meta-actions'; 

            const timeSpan = document.createElement('span'); 
            timeSpan.classList.add('message-timestamp-meta');
            timeSpan.textContent = new Date(timestamp).toLocaleTimeString(currentLanguage === 'fa' ? 'fa-IR' : (currentLanguage === 'az' ? 'az-AZ' : 'en-US'), { hour: '2-digit', minute: '2-digit' }); 
            metaActionsDiv.appendChild(timeSpan); 
            
            const actionsDiv = document.createElement('div'); 
            actionsDiv.className = 'message-actions-meta';
            
            let actionsHTML = `
                <button class="like-btn ${userLiked ? 'liked' : ''}" title="${uiStrings[currentLanguage].messageLiked.split(' ')[1]}">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    <span class="like-count">${likes}</span>
                </button>
                <button class="dislike-btn ${userDisliked ? 'disliked' : ''}" title="${uiStrings[currentLanguage].messageDisliked.split(' ')[1]}">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 3H9c-1.1 0-2 .9-2 2v9c0 .55-.45 1-1 1s-1-.45-1-1V9c0-2.21 1.79-4 4-4h6c1.1 0 2 .9 2 2v9c0 .55.45 1 1 1s1-.45 1-1V5c0-2.21-1.79-4-4-4z"/></svg> <span class="dislike-count">${dislikes}</span>
                </button>
                <button class="copy-btn" title="${uiStrings[currentLanguage].copy}">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </button>
                <button class="share-btn" title="${uiStrings[currentLanguage].share}">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                </button>
            `;
            if (sender === 'user') { 
                actionsHTML += `
                    <button class="edit-btn" title="${uiStrings[currentLanguage].edit}">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    </button>`;
            }
            actionsHTML += `
                <button class="delete-btn" title="${uiStrings[currentLanguage].delete}">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>`;
            
            actionsDiv.innerHTML = actionsHTML; 
            metaActionsDiv.appendChild(actionsDiv); 
            messageContainer.appendChild(metaActionsDiv); 

            actionsDiv.querySelector('.like-btn').addEventListener('click', () => handleLikeDislike(msgId, 'like'));
            actionsDiv.querySelector('.dislike-btn').addEventListener('click', () => handleLikeDislike(msgId, 'dislike'));
            actionsDiv.querySelector('.copy-btn').addEventListener('click', () => handleCopyMessage(text));
            actionsDiv.querySelector('.share-btn').addEventListener('click', () => handleShareMessage(text));
            if (sender === 'user') {
                actionsDiv.querySelector('.edit-btn').addEventListener('click', () => handleEditMessage(msgId, messageBubble)); 
            }
            actionsDiv.querySelector('.delete-btn').addEventListener('click', () => handleDeleteMessage(msgId));

            chatMessagesEl.appendChild(messageContainer); 
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; 
        }

        function handleEditMessage(msgId, messageBubbleEl) { /* ... (handleEditMessage - unchanged from previous correct version) ... */ 
            const msgIndex = chatSessions[currentChatId].messages.findIndex(m => m.id === msgId); 
            if (msgIndex === -1) return; 
            const currentText = chatSessions[currentChatId].messages[msgIndex].text; 
            
            const textSpan = messageBubbleEl.querySelector('.message-text'); 
            if(!textSpan) return; 

            textSpan.innerHTML = ''; 
            const inputField = document.createElement('textarea'); 
            inputField.value = currentText.replace(/<br\s*\/?>/gi, '\n'); 
            inputField.classList.add('message-edit-input'); 
            inputField.rows = Math.max(2, Math.ceil(currentText.length / 30)); 

            const editActionsDiv = document.createElement('div'); 
            editActionsDiv.classList.add('edit-actions', 'flex', 'gap-2', 'mt-2', 'self-end'); 
            editActionsDiv.innerHTML = `
                <button class="save-edit-btn control-button">${uiStrings[currentLanguage].save}</button>
                <button class="cancel-edit-btn control-button">${uiStrings[currentLanguage].cancel}</button>
            `;
            
            messageBubbleEl.insertBefore(inputField, textSpan); 
            messageBubbleEl.insertBefore(editActionsDiv, textSpan);
            textSpan.style.display = 'none'; 
            inputField.focus(); 

            editActionsDiv.querySelector('.save-edit-btn').onclick = () => {
                const newText = inputField.value.trim(); 
                if (newText) { 
                    chatSessions[currentChatId].messages[msgIndex].text = newText; 
                    chatSessions[currentChatId].messages[msgIndex].timestamp = Date.now(); 
                    saveChatSessions(); 
                }
                renderChatMessages(); 
            };
            editActionsDiv.querySelector('.cancel-edit-btn').onclick = () => {
                renderChatMessages(); 
            };
        }

        function handleDeleteMessage(msgId) { /* ... (handleDeleteMessage - unchanged from previous correct version) ... */ 
            if (confirm(uiStrings[currentLanguage].confirmDeleteChat)) { 
                if (currentChatId !== null && chatSessions[currentChatId]) { 
                    chatSessions[currentChatId].messages = chatSessions[currentChatId].messages.filter(m => m.id !== msgId);
                    saveChatSessions(); 
                    renderChatMessages(); 
                }
            }
        }

        function handleLikeDislike(msgId, action) { /* ... (handleLikeDislike - unchanged from previous correct version) ... */ 
            const chat = chatSessions[currentChatId]; 
            if (!chat) return; 
            const msgIndex = chat.messages.findIndex(m => m.id === msgId); 
            if (msgIndex === -1) return; 

            const message = chat.messages[msgIndex]; 
            message.likes = message.likes || 0;
            message.dislikes = message.dislikes || 0;
            message.userLiked = message.userLiked || false;
            message.userDisliked = message.userDisliked || false;

            if (action === 'like') {
                if (message.userLiked) { 
                    message.likes--;
                    message.userLiked = false;
                } else { 
                    message.likes++;
                    message.userLiked = true;
                    if (message.userDisliked) { 
                        message.dislikes--;
                        message.userDisliked = false;
                    }
                }
            } else if (action === 'dislike') {
                if (message.userDisliked) { 
                    message.dislikes--;
                    message.userDisliked = false;
                } else { 
                    message.dislikes++;
                    message.userDisliked = true;
                    if (message.userLiked) { 
                        message.likes--;
                        message.userLiked = false;
                    }
                }
            }
            saveChatSessions(); 
            renderChatMessages(); 
        }

        function handleCopyMessage(text) { /* ... (handleCopyMessage - unchanged from previous correct version) ... */ 
            const textarea = document.createElement('textarea'); 
            textarea.value = text.replace(/<br\s*\/?>/gi, '\n'); 
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea); 
            textarea.select(); 
            try {
                document.execCommand('copy'); 
                alert(uiStrings[currentLanguage].copiedToClipboard); 
            } catch (err) {
                console.error('Failed to copy: ', err); 
            }
            document.body.removeChild(textarea); 
        }

        async function handleShareMessage(text) { /* ... (handleShareMessage - unchanged from previous correct version) ... */ 
            const shareData = { 
                title: uiStrings[currentLanguage].kasriDaru, 
                text: text.replace(/<br\s*\/?>/gi, '\n'), 
            };
            try {
                if (navigator.share) { 
                    await navigator.share(shareData); 
                } else { 
                    handleCopyMessage(text); 
                    alert(uiStrings[currentLanguage].shareNotSupported);
                }
            } catch (err) { 
                console.error('Share failed:', err);
                handleCopyMessage(text); 
                alert(uiStrings[currentLanguage].shareNotSupported);
            }
        }
        
        function buildGeminiChatHistory(chatIdToBuildFrom) { /* ... (buildGeminiChatHistory - unchanged from previous correct version) ... */ 
            if (chatIdToBuildFrom === null || !chatSessions[chatIdToBuildFrom]) return []; 
            return chatSessions[chatIdToBuildFrom].messages
                .filter(msg => msg.id !== 'processing-indicator' && !msg.text.startsWith(`**${uiStrings[currentLanguage].chatSummary}**`)) 
                .map(m => ({ 
                    role: m.sender === 'user' ? 'user' : 'model', 
                    parts: [{ text: m.text }] 
                }));
        }


        async function callGeminiAPI(userMessage, forSuggestions = false) { /* ... (callGeminiAPI - unchanged from previous correct version) ... */ 
            if (!forSuggestions) { 
                isSending = true; 
                addMessageToDOM(uiStrings[currentLanguage].processing, 'bot', 'processing-indicator',0,0,false,false,Date.now()); 
                sendBtn.disabled = true; 
                userInputEl.disabled = true; 
            } else { 
                isSuggesting = true; 
                suggestionSpinnerEl.classList.remove('hidden'); 
                replySuggestionsContainerEl.innerHTML = ''; 
            }

            let historyForAPI = buildGeminiChatHistory(currentChatId); 
            
            let promptText = userMessage; 
            if (forSuggestions) { 
                const relevantHistory = historyForAPI.slice(-3); 
                const historyString = relevantHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n'); 
                promptText = `${uiStrings[currentLanguage].suggestRepliesPrompt || "Based on the following conversation, suggest 3 short, relevant, one-sentence replies for the user. Return as a JSON array of strings. If no good suggestions, return an empty array:\n"}${historyString}\nUser:`;
                historyForAPI = [{role: "user", parts: [{text: promptText}]}]; 
            }

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; 
            
            const payload = { contents: historyForAPI };
            if (forSuggestions) { 
                payload.generationConfig = {
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "ARRAY",
                        items: { type: "STRING" }
                    }
                };
            }
            
            try { 
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (!forSuggestions) { 
                    const processingIndicator = chatMessagesEl.querySelector('[data-id="processing-indicator"]');
                    if (processingIndicator) processingIndicator.remove();
                }

                if (!response.ok) { 
                    const errorData = await response.json(); 
                    console.error("API Error:", errorData); 
                    throw new Error(uiStrings[currentLanguage].serverError); 
                }

                const result = await response.json(); 
                let botResponseText = uiStrings[currentLanguage].noResponse; 

                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    botResponseText = result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback?.blockReason) { 
                    botResponseText = uiStrings[currentLanguage].promptBlocked.replace("{REASON}", result.promptFeedback.blockReason);
                     if (result.promptFeedback.blockReason === "SAFETY" && result.promptFeedback.safetyRatings) { 
                        const harmfulCategories = result.promptFeedback.safetyRatings
                            .filter(rating => rating.probability !== "NEGLIGIBLE" && rating.probability !== "LOW")
                            .map(rating => rating.category.replace('HARM_CATEGORY_', ''));
                        if (harmfulCategories.length > 0) { 
                           botResponseText += ` ${uiStrings[currentLanguage].harmfulContent.replace("{CATEGORIES}", harmfulCategories.join(', '))}`;
                        }
                    }
                }
                
                if (forSuggestions) { 
                    try {
                        const suggestions = JSON.parse(botResponseText); 
                        if (Array.isArray(suggestions) && suggestions.every(s => typeof s === 'string')) { 
                            displayReplySuggestions(suggestions); 
                        } else { 
                            console.warn("Suggestions not in expected array format:", suggestions);
                            displayReplySuggestions([]); 
                        }
                    } catch (e) { 
                        console.error("Error parsing suggestions JSON:", e, "\nReceived text:", botResponseText);
                        displayReplySuggestions([]); 
                    }
                } else { 
                    const botMsgId = Date.now(); 
                    addMessageToDOM(botResponseText, 'bot', botMsgId, 0,0,false,false, botMsgId); 
                    chatSessions[currentChatId].messages.push({ text: botResponseText, sender: 'bot', id: botMsgId, likes:0, dislikes:0, timestamp: botMsgId });
                    saveChatSessions(); 
                    receiveSoundEl.play(); 
                    await callGeminiAPI(null, true); 
                }

            } catch (error) { 
                console.error("Fetch Error:", error);
                if (!forSuggestions) { 
                    const processingIndicator = chatMessagesEl.querySelector('[data-id="processing-indicator"]');
                    if (processingIndicator) processingIndicator.remove(); 
                    const errorMsgId = Date.now(); 
                    addMessageToDOM(error.message || uiStrings[currentLanguage].fetchError, 'bot', errorMsgId,0,0,false,false,errorMsgId); 
                    chatSessions[currentChatId].messages.push({ text: error.message || uiStrings[currentLanguage].fetchError, sender: 'bot', id: errorMsgId, likes:0, dislikes:0, timestamp: errorMsgId });
                    saveChatSessions(); 
                } else { 
                    displayReplySuggestions([]); 
                }
            } finally { 
                if (!forSuggestions) { 
                    isSending = false; 
                    sendBtn.disabled = false; 
                    userInputEl.disabled = false; 
                    userInputEl.focus(); 
                } else { 
                    isSuggesting = false; 
                    suggestionSpinnerEl.classList.add('hidden'); 
                }
            }
        }

        async function handleSendMessage() { /* ... (handleSendMessage - unchanged from previous correct version) ... */ 
            const messageText = userInputEl.value.trim(); 
            if (messageText === '' || isSending) return; 
            if (currentChatId === null) startNewChat(); 
            
            sendSoundEl.play(); 
            const userMessageId = Date.now(); 
            const timestamp = Date.now(); 
            addMessageToDOM(messageText, 'user', userMessageId, 0, 0, false, false, timestamp);
            chatSessions[currentChatId].messages.push({ text: messageText, sender: 'user', id: userMessageId, likes:0, dislikes:0, timestamp: timestamp });
            
            userInputEl.value = ''; 
            clearInputBtn.classList.add('hidden'); 
            replySuggestionsContainerEl.innerHTML = ''; 
            saveChatSessions(); 
            renderChatHistory(); 
            await callGeminiAPI(messageText, false); 
        }
        
        function displayReplySuggestions(suggestions) { /* ... (displayReplySuggestions - unchanged from previous correct version) ... */ 
            replySuggestionsContainerEl.innerHTML = ''; 
            if (suggestions && suggestions.length > 0) { 
                suggestions.slice(0, 3).forEach(suggestionText => { 
                    const chip = document.createElement('button'); 
                    chip.classList.add('suggestion-chip'); 
                    chip.textContent = suggestionText; 
                    chip.onclick = () => { 
                        userInputEl.value = suggestionText; 
                        userInputEl.focus(); 
                        clearInputBtn.classList.remove('hidden'); 
                        replySuggestionsContainerEl.innerHTML = ''; 
                    };
                    replySuggestionsContainerEl.appendChild(chip); 
                });
            } 
            suggestionSpinnerEl.classList.add('hidden'); 
        }

        async function handleSummarizeChat() { /* ... (handleSummarizeChat - unchanged from previous correct version) ... */ 
            if (isSummarizing || currentChatId === null || chatSessions[currentChatId].messages.length < 2) {
                return;
            }
            isSummarizing = true; 
            summarizeChatBtn.disabled = true; 
            const originalBtnText = summarizeChatBtn.textContent; 
            summarizeChatBtn.textContent = uiStrings[currentLanguage].summarizingChat; 

            const historyForSummary = buildGeminiChatHistory(currentChatId); 
            
            const summaryPrompt = `Please provide a concise summary of the following conversation:\n\n${historyForSummary.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}`;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{role: "user", parts: [{text: summaryPrompt}]}] }; 

            try { 
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(uiStrings[currentLanguage].serverError); 
                const result = await response.json(); 
                let summaryText = uiStrings[currentLanguage].noResponse; 
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) { 
                    summaryText = result.candidates[0].content.parts[0].text;
                }
                const summaryMsgId = Date.now(); 
                addMessageToDOM(`**${uiStrings[currentLanguage].chatSummary}**\n${summaryText}`, 'bot', summaryMsgId,0,0,false,false, summaryMsgId);
            } catch (error) { 
                console.error("Summarize Error:", error);
                const errorMsgId = Date.now();
                addMessageToDOM(error.message || uiStrings[currentLanguage].fetchError, 'bot', errorMsgId,0,0,false,false,errorMsgId);
            } finally { 
                isSummarizing = false; 
                summarizeChatBtn.disabled = false; 
                summarizeChatBtn.textContent = originalBtnText; 
            }
        }
        summarizeChatBtn.addEventListener('click', handleSummarizeChat); 


        function renderChatMessages() { /* ... (renderChatMessages - unchanged from previous correct version) ... */ 
            chatMessagesEl.innerHTML = ''; 
            if (currentChatId !== null && chatSessions[currentChatId]) { 
                chatSessions[currentChatId].messages.forEach(msg => {
                    addMessageToDOM(msg.text, msg.sender, msg.id, msg.likes, msg.dislikes, msg.userLiked, msg.userDisliked, msg.timestamp);
                });
            }
        }

        function renderChatHistory() { /* ... (renderChatHistory - unchanged from previous correct version) ... */ 
            chatHistoryEl.innerHTML = ''; 
            const fragment = document.createDocumentFragment(); 
            chatSessions.forEach((session, index) => { 
                const chatItem = document.createElement('div'); 
                chatItem.classList.add('chat-item'); 
                chatItem.dataset.chatId = index; 
                const displayName = session.name || `${uiStrings[currentLanguage].chatDefaultName} ${index + 1}`;
                const lastMessageText = session.messages.length > 0 ? session.messages[session.messages.length -1].text : '...';

                chatItem.innerHTML = `
                    <div class="flex-grow overflow-hidden">
                        <h4>${displayName}</h4>
                        <p>${lastMessageText.slice(0, 25)}...</p>
                    </div>
                    <div class="chat-actions">
                        <button class="edit-chat-name-btn" title="${uiStrings[currentLanguage].enterNewChatName}">✏️</button>
                        <button class="delete-chat-btn" title="${uiStrings[currentLanguage].confirmDeleteChat}">🗑️</button>
                    </div>`;
                chatItem.querySelector('.edit-chat-name-btn').addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    editChatName(index); 
                });
                chatItem.querySelector('.delete-chat-btn').addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    deleteChat(index); 
                });
                chatItem.addEventListener('click', () => loadChat(index)); 
                fragment.appendChild(chatItem); 
            });
            chatHistoryEl.appendChild(fragment); 
        }

        function loadChat(chatIdAsIndex) { /* ... (loadChat - unchanged from previous correct version) ... */ 
            if (chatIdAsIndex >= 0 && chatIdAsIndex < chatSessions.length) { 
                currentChatId = chatIdAsIndex; 
                renderChatMessages(); 
                replySuggestionsContainerEl.innerHTML = ''; 
                const currentMessages = chatSessions[currentChatId]?.messages;
                if (currentMessages && currentMessages.length > 0 && currentMessages[currentMessages.length - 1].sender === 'bot') {
                    callGeminiAPI(null, true); 
                }

                if (window.innerWidth <= 768) sidebarEl.classList.remove('active'); 
            }
        }

        function startNewChat() { /* ... (startNewChat - unchanged from previous correct version) ... */ 
            const newChatSession = { 
                name: `${uiStrings[currentLanguage].chatDefaultName} ${chatSessions.length + 1}`, 
                messages: [{ text: uiStrings[currentLanguage].initialBotMessage, sender: 'bot', id: Date.now(), likes:0, dislikes:0, timestamp: Date.now() }] 
            };
            chatSessions.push(newChatSession); 
            currentChatId = chatSessions.length - 1; 
            renderChatMessages(); 
            renderChatHistory(); 
            saveChatSessions(); 
            replySuggestionsContainerEl.innerHTML = ''; 
            userInputEl.focus(); 
        }
        newChatBtn.addEventListener('click', startNewChat); 

        function editChatName(chatIndex) { /* ... (editChatName - unchanged from previous correct version) ... */ 
            if (chatIndex < 0 || chatIndex >= chatSessions.length) return; 
            const newName = prompt(uiStrings[currentLanguage].enterNewChatName, chatSessions[chatIndex].name); 
            if (newName && newName.trim() !== '') { 
                chatSessions[chatIndex].name = newName.trim(); 
                renderChatHistory(); 
                saveChatSessions(); 
            }
        }
        function deleteChat(chatIndex) { /* ... (deleteChat - unchanged from previous correct version) ... */ 
             if (confirm(uiStrings[currentLanguage].confirmDeleteChat)) { 
                if (chatIndex < 0 || chatIndex >= chatSessions.length) return; 
                
                chatSessions.splice(chatIndex, 1); 
                
                if (currentChatId === chatIndex) { 
                    chatMessagesEl.innerHTML = ''; 
                    replySuggestionsContainerEl.innerHTML = ''; 
                    currentChatId = chatSessions.length > 0 ? 0 : null; 
                    if (currentChatId !== null) loadChat(currentChatId); 
                } else if (currentChatId > chatIndex) { 
                    currentChatId--; 
                }
                renderChatHistory(); 
                saveChatSessions(); 
            }
        }

        clearCurrentChatBtn.addEventListener('click', () => { /* ... (clearCurrentChatBtn - unchanged from previous correct version) ... */ 
            if (currentChatId !== null && chatSessions[currentChatId]) { 
                if (confirm(uiStrings[currentLanguage].confirmClearCurrentChat)) { 
                    chatSessions[currentChatId].messages = [
                        { text: uiStrings[currentLanguage].initialBotMessage, sender: 'bot', id: Date.now(), likes:0, dislikes:0, timestamp: Date.now() }
                    ];
                    saveChatSessions(); 
                    renderChatMessages(); 
                    replySuggestionsContainerEl.innerHTML = ''; 
                }
            }
        });

        function saveChatSessions() { localStorage.setItem('kasriChatSessions', JSON.stringify(chatSessions)); }
        function loadChatSessions() { /* ... (loadChatSessions - unchanged from previous correct version) ... */ 
            const storedSessions = localStorage.getItem('kasriChatSessions'); 
            if (storedSessions) { 
                chatSessions = JSON.parse(storedSessions); 
                chatSessions.forEach(session => {
                    session.messages.forEach(msg => {
                        msg.likes = msg.likes || 0;
                        msg.dislikes = msg.dislikes || 0;
                        msg.userLiked = msg.userLiked || false;
                        msg.userDisliked = msg.userDisliked || false;
                        msg.timestamp = msg.timestamp || msg.id; 
                    });
                });
                if (chatSessions.length > 0) {
                    currentChatId = 0; 
                } else {
                    currentChatId = null; 
                }
            } else { 
                chatSessions = []; 
                currentChatId = null;
            }
            renderChatHistory(); 
        }

        // ====================================================================================================
        // 📌 [6] شنونده‌های رویداد (Event Listeners)
        // این بخش شامل تعریف و اتصال شنونده‌های رویداد به عناصر مختلف صفحه است
        // تا به تعاملات کاربر (مانند کلیک، تایپ و ...) پاسخ داده شود.
        // حق تکثیر: کسری شیرعلیزاده
        // ====================================================================================================
        sendBtn.addEventListener('click', handleSendMessage); 
        userInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isSending) { e.preventDefault(); handleSendMessage(); } }); 
        userInputEl.addEventListener('input', () => {
            if (userInputEl.value.trim() !== '') {
                clearInputBtn.classList.remove('hidden');
            } else {
                clearInputBtn.classList.add('hidden');
            }
        });
        clearInputBtn.addEventListener('click', () => { 
            userInputEl.value = '';
            clearInputBtn.classList.add('hidden');
            userInputEl.focus();
        });

        themeSelectEl.addEventListener('change', (e) => applyTheme(e.target.value));
        fontSelectEl.addEventListener('change', (e) => applyFont(e.target.value));
        fontSizeSliderEl.addEventListener('input', (e) => applyFontSize(e.target.value));
        languageSelectEl.addEventListener('change', (e) => applyLanguage(e.target.value));
        
        settingsBtn.addEventListener('click', () => {
            settingsPanelEl.style.display = settingsPanelEl.style.display === 'none' ? 'block' : 'none';
            settingsBtn.setAttribute('aria-expanded', settingsPanelEl.style.display === 'block');
        });
        closeSettingsPanelBtn.addEventListener('click', () => { // بستن پنل تنظیمات با دکمه X
             settingsPanelEl.style.display = 'none';
             if(settingsBtn) settingsBtn.setAttribute('aria-expanded', 'false');
        });
        document.addEventListener('click', (e) => {
            if (settingsPanelEl && !settingsPanelEl.contains(e.target) && settingsBtn && !settingsBtn.contains(e.target)) {
                settingsPanelEl.style.display = 'none';
                if(settingsBtn) settingsBtn.setAttribute('aria-expanded', 'false');
            }
        });
        hamburgerBtn.addEventListener('click', () => sidebarEl.classList.toggle('active'));
        hideSidebarBtn.addEventListener('click', () => sidebarEl.classList.remove('active'));
        
        [toggleAdSectionBtn, toggleMoreInfoBtn, toggleUsefulLinksBtn, toggleSearchSectionBtn, toggleSystemInfoBtn].forEach(btn => { 
            if (btn) { 
                btn.addEventListener('click', () => {
                    const content = btn.nextElementSibling; 
                    if (content) { 
                        const isHidden = content.classList.toggle('hidden'); 
                        btn.setAttribute('aria-expanded', String(!isHidden)); 
                        const arrowSpan = btn.querySelector('.arrow'); 
                        if (arrowSpan) { 
                            arrowSpan.textContent = !isHidden ? '▲' : '▼';
                        }
                    }
                });
            }
        });

        particleToggleEl.addEventListener('change', (e) => toggleParticles(e.target.checked));
        resetSettingsBtn.addEventListener('click', () => {
            if (confirm(uiStrings[currentLanguage].confirmResetSettings)) { 
                localStorage.removeItem('kasriChatTheme');
                localStorage.removeItem('kasriChatLanguage');
                localStorage.removeItem('kasriChatFont');
                localStorage.removeItem('kasriChatFontSize');
                localStorage.removeItem('kasriParticlesEnabled');
                currentTheme = defaultSettings.theme;
                currentLanguage = defaultSettings.language;
                currentFont = defaultSettings.font;
                currentFontSize = defaultSettings.fontSize;
                particlesEnabled = defaultSettings.particlesEnabled;
                initializeAppVisuals(); 
                alert(uiStrings[currentLanguage].settingsReset); 
            }
        });
        helpGuideBtn.addEventListener('click', () => helpModalOverlayEl.classList.add('active'));
        closeHelpModalBtn.addEventListener('click', () => helpModalOverlayEl.classList.remove('active'));
        helpModalOverlayEl.addEventListener('click', (e) => { if (e.target === helpModalOverlayEl) helpModalOverlayEl.classList.remove('active'); }); 
        
        chatMessagesEl.addEventListener('scroll', () => {
            if (chatMessagesEl.scrollTop < chatMessagesEl.scrollHeight - chatMessagesEl.clientHeight - 100) { 
                scrollToBottomBtn.classList.remove('hidden'); 
                 scrollToBottomBtn.classList.add('visible');
            } else { 
                scrollToBottomBtn.classList.remove('visible');
                 scrollToBottomBtn.classList.add('hidden');
            }
        });
        scrollToBottomBtn.addEventListener('click', () => { 
            chatMessagesEl.scrollTo({ top: chatMessagesEl.scrollHeight, behavior: 'smooth' });
        });

        openSearchModalSidebarBtn.addEventListener('click', () => { // باز کردن مودال جستجو از سایدبار
            searchModalOverlayEl.classList.add('active'); 
            modalSearchInputEl.focus(); 
        });
        closeSearchModalBtn.addEventListener('click', () => searchModalOverlayEl.classList.remove('active'));
        searchModalOverlayEl.addEventListener('click', (e) => { if(e.target === searchModalOverlayEl) searchModalOverlayEl.classList.remove('active'); });
        modalSearchExecuteBtn.addEventListener('click', performModalSearch);
        modalSearchInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') performModalSearch(); });

        function performModalSearch() { /* ... (performModalSearch - unchanged from previous correct version) ... */ 
            const keyword = modalSearchInputEl.value.trim().toLowerCase(); 
            searchResultsContainerEl.innerHTML = ''; 
            if (!keyword) return; 

            let resultsFound = 0; 
            chatSessions.forEach((session, chatIndex) => { 
                session.messages.forEach(msg => { 
                    if (msg.text.toLowerCase().includes(keyword)) { 
                        resultsFound++; 
                        const resultItem = document.createElement('div'); 
                        resultItem.classList.add('search-result-item-modal');
                        resultItem.innerHTML = `
                            <strong>${session.name || `${uiStrings[currentLanguage].chatDefaultName} ${chatIndex + 1}`}</strong>
                            <p>${msg.text.length > 100 ? msg.text.slice(0,100)+'...' : msg.text}</p> `;
                        resultItem.onclick = () => { 
                            loadChat(chatIndex); 
                            searchModalOverlayEl.classList.remove('active'); 
                            if (window.innerWidth <= 768) sidebarEl.classList.remove('active'); 
                        };
                        searchResultsContainerEl.appendChild(resultItem); 
                    }
                });
            });

            if (resultsFound === 0) { 
                searchResultsContainerEl.innerHTML = `<p class="text-center text-sm text-[color:var(--text-secondary)] p-4">${uiStrings[currentLanguage].noResultsFound}</p>`;
            }
        }

        visitSiteAdBtn.addEventListener('click', () => window.open('https://kasridaru.com', '_blank')); 

        function updateDateTime() { /* ... (updateDateTime - unchanged from previous correct version) ... */ 
             const now = new Date(); 
            dateTimeEl.textContent = now.toLocaleString(currentLanguage === 'fa' ? 'fa-IR' : (currentLanguage === 'az' ? 'az-AZ' : 'en-US'), {
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                hour: 'numeric', minute: 'numeric'
            });
        }
        setInterval(updateDateTime, 10000); 

        function updateHelpModalContent() { /* ... (updateHelpModalContent - unchanged from previous correct version, ensure az translations are added to uiStrings) ... */ 
            const lang = currentLanguage; 
            helpModalContentEl.innerHTML = `
                <p>${uiStrings[lang].helpIntro}</p>
                <ul>
                    <li>${uiStrings[lang].helpThemes}</li>
                    <li>${uiStrings[lang].helpLanguage}</li>
                    <li>${uiStrings[lang].helpFont}</li>
                    <li>${uiStrings[lang].helpParticles}</li>
                    <li>${uiStrings[lang].helpNewChat}</li>
                    <li>${uiStrings[lang].helpChatHistory}</li>
                    <li>${uiStrings[lang].helpMessageActions}</li>
                    <li>${uiStrings[lang].helpSummarize}</li>
                    <li>${uiStrings[lang].helpSuggestReplies}</li>
                    <li>${uiStrings[lang].helpMessageTimestamp}</li>
                    <li>${uiStrings[lang].helpScrollToBottom}</li>
                    <li>${uiStrings[lang].helpClearInput}</li>
                    <li>${uiStrings[lang].helpSearch}</li>
                    <li>${uiStrings[lang].helpSystemInfo}</li> 
                    <li>${uiStrings[lang].helpReset}</li>
                </ul>`;
        }

        function initializeAppVisuals() { /* ... (initializeAppVisuals - unchanged from previous correct version) ... */ 
            applyTheme(currentTheme); themeSelectEl.value = currentTheme; 
            applyFont(currentFont); fontSelectEl.value = currentFont; 
            applyFontSize(currentFontSize); fontSizeSliderEl.value = currentFontSize; 
            applyLanguage(currentLanguage); languageSelectEl.value = currentLanguage; 
            particleToggleEl.checked = particlesEnabled; 
            if (particlesEnabled) { initParticles(); animateParticles(); } 
        }
        
        // تابع برای دریافت اطلاعات سیستم کاربر - حق تکثیر: کسری شیرعلیزاده
        function displaySystemInfo() {
            let browserName = "ناشناخته";
            const userAgent = navigator.userAgent;
            if (userAgent.indexOf("Firefox") > -1) browserName = "Firefox";
            else if (userAgent.indexOf("SamsungBrowser") > -1) browserName = "Samsung Internet";
            else if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) browserName = "Opera";
            else if (userAgent.indexOf("Trident") > -1) browserName = "Internet Explorer";
            else if (userAgent.indexOf("Edge") > -1) browserName = "Edge (Legacy)";
            else if (userAgent.indexOf("Edg") > -1) browserName = "Edge (Chromium)";
            else if (userAgent.indexOf("Chrome") > -1) browserName = "Chrome";
            else if (userAgent.indexOf("Safari") > -1) browserName = "Safari";
            
            let osName = "ناشناخته";
            if (navigator.appVersion.indexOf("Win") != -1) osName = "Windows";
            if (navigator.appVersion.indexOf("Mac") != -1) osName = "MacOS";
            if (navigator.appVersion.indexOf("X11") != -1) osName = "UNIX";
            if (navigator.appVersion.indexOf("Linux") != -1) osName = "Linux";
            if (navigator.appVersion.indexOf("Android") != -1) osName = "Android";
            if (navigator.appVersion.indexOf("iOS") != -1) osName = "iOS";

            browserInfoEl.textContent = browserName;
            osInfoEl.textContent = osName;
            langPrefsInfoEl.textContent = navigator.languages ? navigator.languages.join(', ') : navigator.language;
        }


        // تابع اصلی برای مقداردهی اولیه کل برنامه - حق تکثیر: کسری شیرعلیزاده
        function initializeApp() {
            initializeAppVisuals(); // مقداردهی اولیه تنظیمات ظاهری
            loadChatSessions(); // بارگذاری جلسات چت از localStorage
            // مدیریت وضعیت اولیه چت (اگر چتی وجود ندارد، یک چت جدید شروع کن)
            if (currentChatId === null && chatSessions.length === 0) {
                startNewChat();
            } else if (currentChatId !== null && currentChatId < chatSessions.length && chatSessions[currentChatId]) { 
                loadChat(currentChatId); // بارگذاری چت فعال قبلی
            } else if (chatSessions.length > 0) { // اگر چت فعالی از قبل مشخص نشده بود ولی چتی وجود دارد
                currentChatId = 0; // اولین چت را فعال کن
                loadChat(currentChatId);
            }

            updateDateTime(); // به‌روزرسانی اولیه تاریخ و زمان
            updateHelpModalContent(); // به‌روزرسانی اولیه محتوای راهنما
            displaySystemInfo(); // نمایش اطلاعات سیستم کاربر
            userInputEl.focus(); // قرار دادن فوکوس روی فیلد ورودی پیام

            // نمایش راهنما در اولین بازدید کاربر - حق تکثیر: کسری شیرعلیزاده
            if (!localStorage.getItem('kasriChatHelpShown')) {
                helpModalOverlayEl.classList.add('active'); // نمایش مودال راهنما
                localStorage.setItem('kasriChatHelpShown', 'true'); // ذخیره وضعیت نمایش راهنما
            }
        }
        initializeApp(); // اجرای تابع مقداردهی اولیه برنامه
    </script>
</body>
</html>
